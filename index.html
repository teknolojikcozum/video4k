<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecMaster: Modern Ekran Kaydedici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .recording-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Crop Box */
        #crop-container {
            user-select: none;
            touch-action: none;
            overflow: hidden;
            cursor: crosshair;
        }
        #crop-box {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); 
            cursor: move;
            z-index: 20;
            outline: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            display: block; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #crop-box.recording-mode {
            box-shadow: none;
            cursor: default;
            pointer-events: none;
            background: transparent;
            outline: 3px solid rgba(239, 68, 68, 0.8); 
            outline-offset: 2px;
            animation: guide-pulse 2s infinite;
            border-radius: 0;
        }
        
        /* Fullscreen Mode Override */
        #crop-box.fullscreen-mode {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            cursor: default;
            outline: 2px solid rgba(74, 222, 128, 0.5);
            border-radius: 0;
        }
        #crop-box.fullscreen-mode .resize-handle {
            display: none !important;
        }
        
        @keyframes guide-pulse {
            0% { outline-color: rgba(239, 68, 68, 1); }
            50% { outline-color: rgba(239, 68, 68, 0.3); }
            100% { outline-color: rgba(239, 68, 68, 1); }
        }

        .resize-handle {
            width: 12px;
            height: 12px;
            background-color: white;
            border: 2px solid #ef4444;
            position: absolute;
            border-radius: 50%;
            z-index: 30;
            transition: transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .resize-handle:hover { transform: scale(1.5); background-color: #ef4444; }
        .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }

        /* Segmented Control */
        .segmented-control {
            background: rgba(2, 6, 23, 0.5);
            padding: 4px;
            border-radius: 10px;
            display: inline-flex;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .segment-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .segment-btn:hover { color: #cbd5e1; }
        .segment-btn.active {
            background: #1e293b;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Audio Visualizer Bar */
        .audio-meter {
            width: 4px;
            background-color: #334155;
            border-radius: 2px;
            transition: height 0.05s ease;
            height: 4px;
        }
        .audio-meter.active {
            background-color: #4ade80;
            box-shadow: 0 0 4px #4ade80;
        }

        /* Cam Position Grid */
        .cam-pos-btn {
            background-color: #334155;
            border-radius: 2px;
            width: 100%;
            height: 100%;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .cam-pos-btn:hover { background-color: #475569; }
        .cam-pos-btn.active { background-color: #f8fafc; border-color: #94a3b8; box-shadow: 0 0 4px rgba(255,255,255,0.3); }
        
        /* Hidden UI State */
        .ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, 20px) !important;
        }

        /* Webcam Preview Layer */
        #webcam-preview-layer {
            position: absolute;
            z-index: 25;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            background: #000;
            pointer-events: auto;
        }
        #webcam-preview-layer video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        /* Cam Positions */
        .cam-pos-top-left { top: 20px; left: 20px; }
        .cam-pos-top-right { top: 20px; right: 20px; }
        .cam-pos-bottom-left { bottom: 20px; left: 20px; }
        .cam-pos-bottom-right { bottom: 20px; right: 20px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden select-none bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center">
    
    <!-- Backdrop Overlay -->
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm z-0"></div>

    <!-- Header -->
    <header class="h-16 flex items-center px-6 justify-between shrink-0 z-50 relative border-b border-white/5 bg-slate-950/50 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-white/5 rounded-xl flex items-center justify-center border border-white/10 shadow-inner">
                <i class="fa-solid fa-record-vinyl text-red-500 text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white leading-tight">RecMaster</h1>
                <p class="text-[10px] text-slate-500 font-medium">Ultimate Screen Recorder</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- YouTube Channel Link -->
            <a href="https://www.youtube.com/@teknolojikcozumvideo" target="_blank" class="flex items-center gap-2 bg-red-600/10 hover:bg-red-600/20 text-red-500 px-3 py-1.5 rounded-lg border border-red-500/20 transition-colors text-xs font-medium no-underline mr-2">
                <i class="fa-brands fa-youtube text-sm"></i>
                <span class="hidden md:inline">Teknolojik Ã‡Ã¶zÃ¼m VideolarÄ±</span>
            </a>

            <div id="keyboard-hint" class="hidden md:flex gap-2 text-[10px] text-slate-500 font-mono items-center">
                <!-- F8 kaldÄ±rÄ±ldÄ± -->
                <div class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded border border-white/5">
                    <kbd class="font-sans">F9</kbd> Duraklat
                </div>
                <div class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded border border-white/5">
                    <kbd class="font-sans">F10</kbd> Bitir
                </div>
            </div>
            <div id="status-badge" class="text-[10px] uppercase tracking-wider px-3 py-1 rounded-full border border-slate-700 text-slate-400 font-bold bg-slate-900/50">HazÄ±r</div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden relative items-center justify-center p-6 z-10">
        
        <!-- Privacy/Browser Warning -->
        <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 text-[10px] text-slate-500 bg-slate-900/80 px-4 py-2 rounded-full border border-slate-800 backdrop-blur-sm pointer-events-none z-0 flex items-center gap-2 whitespace-nowrap">
            <i class="fa-solid fa-lock text-green-500"></i>
            <span>%100 Gizli: Verileriniz sunucuya gÃ¶nderilmez, sadece tarayÄ±cÄ±nÄ±zda iÅŸlenir.</span>
        </div>

        <!-- VIEW 1: Setup Panel -->
        <div id="setup-panel" class="w-full max-w-[520px] glass rounded-[32px] p-12 shadow-2xl relative overflow-hidden animate-fade-in border border-white/10">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-indigo-600/20 rounded-full blur-[100px]"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-rose-600/20 rounded-full blur-[100px]"></div>
            
            <div class="text-center mb-10 relative z-10">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/5 mb-6 border border-white/10 shadow-inner">
                    <i class="fa-solid fa-sliders text-3xl text-slate-300"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2 tracking-tight">Yeni KayÄ±t OluÅŸtur</h2>
                <p class="text-slate-400 text-sm">Ses ve gÃ¶rÃ¼ntÃ¼ kaynaklarÄ±nÄ±zÄ± seÃ§erek baÅŸlayÄ±n.</p>
            </div>

            <div class="space-y-6 relative z-10">
                <div class="grid grid-cols-2 gap-5">
                    <!-- Mic Toggle -->
                    <label class="cursor-pointer bg-slate-800/40 hover:bg-slate-800/70 border border-white/5 hover:border-indigo-500/30 rounded-2xl p-6 flex flex-col items-center justify-center gap-4 transition-all group relative overflow-hidden">
                        <div class="absolute inset-0 bg-indigo-500/0 group-hover:bg-indigo-500/5 transition-colors duration-300"></div>
                        <div class="w-14 h-14 rounded-full bg-slate-700/50 flex items-center justify-center group-hover:bg-indigo-500/20 transition-colors duration-300 ring-1 ring-white/5">
                            <i class="fa-solid fa-microphone text-2xl text-slate-400 group-hover:text-indigo-400 transition-colors duration-300" id="icon-mic"></i>
                        </div>
                        <div class="text-center z-10">
                            <span class="text-base font-semibold text-slate-200 block mb-0.5">Mikrofon</span>
                            <span class="text-[11px] text-slate-500">Sesli AnlatÄ±m</span>
                        </div>
                        <input type="checkbox" id="mic-toggle" class="accent-indigo-500 w-5 h-5 mt-1 border-white/10 bg-slate-900/50">
                    </label>

                    <!-- Webcam Toggle -->
                    <label class="cursor-pointer bg-slate-800/40 hover:bg-slate-800/70 border border-white/5 hover:border-rose-500/30 rounded-2xl p-6 flex flex-col items-center justify-center gap-4 transition-all group relative overflow-hidden">
                        <div class="absolute inset-0 bg-rose-500/0 group-hover:bg-rose-500/5 transition-colors duration-300"></div>
                        <div class="w-14 h-14 rounded-full bg-slate-700/50 flex items-center justify-center group-hover:bg-rose-500/20 transition-colors duration-300 ring-1 ring-white/5">
                            <i class="fa-solid fa-video text-2xl text-slate-400 group-hover:text-rose-400 transition-colors duration-300" id="icon-cam"></i>
                        </div>
                        <div class="text-center z-10">
                            <span class="text-base font-semibold text-slate-200 block mb-0.5">Webcam</span>
                            <span class="text-[11px] text-slate-500">GÃ¶rÃ¼ntÃ¼lÃ¼</span>
                        </div>
                        <input type="checkbox" id="cam-toggle" class="accent-rose-500 w-5 h-5 mt-1 border-white/10 bg-slate-900/50">
                    </label>
                </div>

                <button id="init-btn" class="w-full bg-white text-slate-950 hover:bg-slate-200 font-bold py-5 rounded-2xl shadow-xl transform transition-all active:scale-[0.99] flex items-center justify-center gap-3 text-base mt-2 group">
                    <span>EkranÄ± SeÃ§ & Ä°lerle</span>
                    <i class="fa-solid fa-arrow-right text-slate-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>

        <!-- VIEW 2: Result & Download Panel -->
        <div id="result-panel" class="hidden w-full h-full flex flex-col items-center justify-center gap-8 animate-fade-in z-30 p-6 relative">
            <div class="w-full max-w-5xl bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative group ring-1 ring-white/5 aspect-video flex items-center justify-center bg-zinc-900">
                <video id="preview-video" class="max-w-full max-h-full" controls></video>
                <div class="absolute top-6 left-6 bg-black/50 px-3 py-1.5 rounded-full text-xs backdrop-blur-md text-white border border-white/10 pointer-events-none font-medium flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div> SonuÃ§
                </div>
            </div>
            <div class="w-full max-w-5xl glass p-8 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-6 border border-white/5">
                <div>
                    <h3 class="text-white font-bold text-2xl mb-1">KayÄ±t BaÅŸarÄ±lÄ±!</h3>
                    <p class="text-slate-400 text-sm">DosyanÄ±zÄ± indirmek iÃ§in bir format seÃ§in.</p>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button id="download-mp4" class="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 transition-all shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:-translate-y-1">
                        <i class="fa-brands fa-windows text-indigo-200 text-lg"></i> MP4 Ä°ndir
                    </button>
                    <button id="download-webm" class="flex-1 md:flex-none bg-slate-800 hover:bg-slate-700 text-white border border-white/10 px-8 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 transition-all hover:-translate-y-1">
                        <i class="fa-brands fa-chrome text-slate-400 text-lg"></i> WebM Ä°ndir
                    </button>
                    <div class="w-px h-10 bg-white/10 mx-2 hidden md:block"></div>
                    <button id="new-record-btn" class="bg-transparent hover:bg-white/5 text-slate-400 hover:text-white px-5 py-4 rounded-2xl transition-colors" title="Sil ve Yeni KayÄ±t">
                        <i class="fa-solid fa-trash-can text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Global Overlays (Moved to BODY for proper z-indexing) -->
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-6 right-6 bg-slate-900/95 border border-slate-700 text-white px-5 py-3 rounded-xl shadow-2xl z-[9999] flex items-center animate-fade-in text-sm font-medium backdrop-blur transition-all duration-300">
        <i class="fa-solid fa-circle-info text-indigo-400 mr-3 text-lg"></i> <span id="toast-msg">Mesaj</span>
    </div>
    
    <!-- Countdown Overlay -->
    <div id="countdown-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[9998] flex items-center justify-center">
        <div class="text-9xl font-black text-white animate-pulse tabular-nums tracking-tighter" id="countdown-text">3</div>
    </div>

    <!-- Processing Overlay (NEW) -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-slate-950/95 z-[10000] flex flex-col items-center justify-center animate-fade-in">
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-bold text-white mb-2 tracking-tight">Video HazÄ±rlanÄ±yor</h2>
        <p class="text-slate-400 text-sm">KaydÄ±nÄ±z iÅŸleniyor ve indirilmeye hazÄ±rlanÄ±yor, lÃ¼tfen bekleyin...</p>
    </div>

    <!-- Crop/Area Selection Overlay (Preview Mode) -->
    <div id="crop-overlay" class="hidden fixed inset-0 bg-slate-950 z-[9990] flex flex-col animate-fade-in">
        <!-- Toolbar (Gizlenebilir) -->
        <div id="crop-toolbar" class="h-20 border-b border-white/5 bg-slate-900/90 flex items-center justify-between px-8 shrink-0 z-50 backdrop-blur-xl transition-transform duration-300">
            
            <div class="flex items-center gap-6">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">KayÄ±t Modu</span>
                    <div class="segmented-control">
                        <button type="button" class="segment-btn active" data-mode="fullscreen">
                            <i class="fa-solid fa-expand mr-2"></i> Tam Ekran
                        </button>
                        <button type="button" class="segment-btn" data-mode="custom">
                            <i class="fa-solid fa-crop-simple mr-2"></i> KÄ±rp
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dynamic Controls -->
            <div class="flex items-center gap-6">
                <!-- Audio Visualizer -->
                <div id="audio-preview" class="hidden items-center gap-3 border-r border-white/10 pr-6 h-10">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] uppercase text-slate-500 font-bold leading-none mb-1">Ses</span>
                        <i class="fa-solid fa-microphone text-slate-400 text-xs"></i>
                    </div>
                    <div class="flex items-end gap-1 h-6">
                        <div class="audio-meter h-2 w-1.5 rounded-sm"></div>
                        <div class="audio-meter h-3 w-1.5 rounded-sm"></div>
                        <div class="audio-meter h-5 w-1.5 rounded-sm"></div>
                        <div class="audio-meter h-3 w-1.5 rounded-sm"></div>
                        <div class="audio-meter h-2 w-1.5 rounded-sm"></div>
                    </div>
                </div>

                <!-- Camera Position Controls -->
                <div id="cam-controls" class="hidden items-center gap-3 border-r border-white/10 pr-6 h-10">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] uppercase text-slate-500 font-bold leading-none mb-1">Webcam</span>
                        <span class="text-[10px] text-slate-400">Konum & Åžekil</span>
                    </div>
                    <div class="grid grid-cols-2 gap-1 w-8 h-8 bg-slate-800 rounded p-0.5 shadow-inner" title="Kamera Konumu">
                        <button class="cam-pos-btn rounded-sm" data-pos="top-left"></button>
                        <button class="cam-pos-btn rounded-sm" data-pos="top-right"></button>
                        <button class="cam-pos-btn rounded-sm" data-pos="bottom-left"></button>
                        <button class="cam-pos-btn active rounded-sm" data-pos="bottom-right"></button>
                    </div>
                    <button id="cam-shape-btn" class="w-8 h-8 rounded bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 flex items-center justify-center text-xs border border-white/5 transition-all shadow-sm" title="Åžekil DeÄŸiÅŸtir">
                        <i class="fa-solid fa-circle"></i>
                    </button>
                </div>

                <button id="start-recording-btn" class="bg-red-600 hover:bg-red-500 text-white pl-5 pr-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-red-900/40 flex items-center gap-3 transition-all hover:scale-105 active:scale-95 group border border-red-500">
                    <span class="relative flex h-3 w-3 group-data-[recording=true]:hidden">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-300 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-white"></span>
                    </span>
                    <span class="btn-text tracking-wide">KAYDI BAÅžLAT</span>
                </button>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="flex-1 relative bg-black/90 overflow-hidden flex items-center justify-center p-8 h-full">
            <div id="crop-container" class="relative shadow-2xl ring-1 ring-white/10 rounded-lg overflow-hidden bg-black max-w-full max-h-full">
                <!-- Source Video Preview -->
                <video id="crop-source-video" autoplay muted class="block max-w-full max-h-[80vh] opacity-100"></video>
                
                <!-- Draggable Crop Box -->
                <div id="crop-box" class="absolute hidden" style="top: 10%; left: 10%; width: 50%; height: 50%;">
                    <div class="resize-handle handle-nw" data-dir="nw"></div>
                    <div class="resize-handle handle-ne" data-dir="ne"></div>
                    <div class="resize-handle handle-sw" data-dir="sw"></div>
                    <div class="resize-handle handle-se" data-dir="se"></div>
                    
                    <!-- Webcam Preview Layer (Live) -->
                    <div id="webcam-preview-layer" class="hidden w-32 h-32 rounded-full cam-pos-bottom-right">
                        <video id="webcam-live-feed" autoplay muted playsinline></video>
                    </div>

                    <div class="absolute -top-10 left-0 bg-white text-black text-[10px] font-bold px-3 py-1.5 rounded shadow-lg opacity-90 transform translate-y-2 group-hover:translate-y-0 transition-transform" id="crop-label">
                        TÃœM EKRAN
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recording Status Bar -->
    <div id="recording-status" class="hidden fixed top-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md border border-white/10 pr-4 pl-6 py-2.5 rounded-full flex items-center gap-6 shadow-2xl z-[9999] transition-all duration-500 ease-in-out">
        <div class="flex items-center gap-3">
            <div class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75" id="rec-dot-anim"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500" id="rec-dot"></span>
            </div>
            <span class="font-mono text-xl w-20 tracking-wider font-bold text-white" id="timer">00:00</span>
        </div>
        
        <div class="h-6 w-px bg-white/10"></div>

        <div class="flex gap-2">
            <button id="pause-btn" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 text-yellow-500 flex items-center justify-center transition-colors border border-white/5 tooltip-trigger active:scale-95" title="Duraklat (F9)">
                <i class="fa-solid fa-pause text-sm"></i>
            </button>
            <button id="stop-btn-top" class="w-10 h-10 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg transition-colors tooltip-trigger active:scale-95" title="Bitir (F10)">
                <i class="fa-solid fa-stop text-sm"></i>
            </button>
        </div>
    </div>

    <!-- Hidden Video Elements for Composition -->
    <video id="src-video-screen" autoplay muted class="hidden"></video>
    <video id="src-video-cam" autoplay muted class="hidden"></video>
    <!-- Master Canvas for Recording -->
    <canvas id="compositor-canvas" class="hidden"></canvas>

    <script>
        /** RecMaster Modern Logic **/
        
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlobUrl = null;
        let timerInt;
        let totalSeconds = 0;
        let isPaused = false;
        let isCropMode = false;
        let isRecording = false;
        
        // Cam & Audio State
        let camPosition = 'bottom-right';
        let camShape = 'circle';
        let audioContext, analyser, dataArray, animationId;
        
        let cropState = { sx: 0, sy: 0, sw: 0, sh: 0 };
        let streams = { display: null, user: null };

        const els = {
            setupPanel: document.getElementById('setup-panel'),
            resultPanel: document.getElementById('result-panel'),
            recordingStatus: document.getElementById('recording-status'),
            countdownOverlay: document.getElementById('countdown-overlay'),
            countdownText: document.getElementById('countdown-text'),
            cropOverlay: document.getElementById('crop-overlay'),
            cropToolbar: document.getElementById('crop-toolbar'), 
            cropSourceVideo: document.getElementById('crop-source-video'),
            cropBox: document.getElementById('crop-box'),
            cropContainer: document.getElementById('crop-container'),
            cropLabel: document.getElementById('crop-label'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            processingOverlay: document.getElementById('processing-overlay'), // NEW
            
            initBtn: document.getElementById('init-btn'),
            startRecordingBtn: document.getElementById('start-recording-btn'),
            stopBtn: document.getElementById('stop-btn-top'),
            pauseBtn: document.getElementById('pause-btn'),
            timer: document.getElementById('timer'),
            statusBadge: document.getElementById('status-badge'),
            previewVideo: document.getElementById('preview-video'),
            micToggle: document.getElementById('mic-toggle'),
            camToggle: document.getElementById('cam-toggle'),
            iconMic: document.getElementById('icon-mic'),
            iconCam: document.getElementById('icon-cam'),
            
            audioPreview: document.getElementById('audio-preview'),
            camControls: document.getElementById('cam-controls'),
            audioMeters: document.querySelectorAll('.audio-meter'),
            camPosBtns: document.querySelectorAll('.cam-pos-btn'),
            camShapeBtn: document.getElementById('cam-shape-btn'),
            
            webcamPreviewLayer: document.getElementById('webcam-preview-layer'),
            webcamLiveFeed: document.getElementById('webcam-live-feed'),
            
            recDot: document.getElementById('rec-dot'),
            recDotAnim: document.getElementById('rec-dot-anim')
        };

        // --- Helpers ---
        function showToast(msg) {
            els.toastMsg.innerText = msg;
            els.toast.classList.remove('hidden');
            setTimeout(() => els.toast.classList.add('hidden'), 3000);
        }

        function updatePageTitle() {
            if (isRecording) {
                if (isPaused) {
                    document.title = `â¸ï¸ DuraklatÄ±ldÄ± | RecMaster`;
                } else {
                    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const s = (totalSeconds % 60).toString().padStart(2, '0');
                    document.title = `ðŸ”´ ${m}:${s} Kaydediliyor | RecMaster`;
                }
            } else {
                document.title = "RecMaster: Modern Ekran Kaydedici";
            }
        }

        // --- UI Interactions ---
        els.micToggle.addEventListener('change', (e) => {
            els.iconMic.className = e.target.checked ? "fa-solid fa-microphone text-xl text-indigo-400 transition-colors" : "fa-solid fa-microphone text-xl text-slate-400 transition-colors";
        });
        els.camToggle.addEventListener('change', (e) => {
            els.iconCam.className = e.target.checked ? "fa-solid fa-video text-xl text-rose-400 transition-colors" : "fa-solid fa-video text-xl text-slate-400 transition-colors";
        });

        // Mode Switching
        document.querySelectorAll('.segment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const mode = btn.dataset.mode;
                isCropMode = (mode === 'custom');
                
                updateCropBoxMode();
            });
        });

        function updateCropBoxMode() {
            if (isCropMode) {
                // Custom Mode: Enable sizing
                els.cropBox.classList.remove('fullscreen-mode');
                const contW = els.cropSourceVideo.offsetWidth;
                const contH = els.cropSourceVideo.offsetHeight;
                els.cropBox.style.width = `${contW * 0.8}px`;
                els.cropBox.style.height = `${contH * 0.8}px`;
                els.cropBox.style.left = `${contW * 0.1}px`;
                els.cropBox.style.top = `${contH * 0.1}px`;
                els.cropLabel.innerText = "KAYIT ALANI";
            } else {
                // Fullscreen Mode: Lock to full
                els.cropBox.classList.add('fullscreen-mode');
                els.cropBox.style.width = '100%';
                els.cropBox.style.height = '100%';
                els.cropBox.style.left = '0';
                els.cropBox.style.top = '0';
                els.cropLabel.innerText = "TÃœM EKRAN";
            }
            updateCropLabels();
        }

        // Cam Position & Shape
        els.camPosBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.camPosBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Remove old pos classes
                els.webcamPreviewLayer.classList.remove('cam-pos-top-left', 'cam-pos-top-right', 'cam-pos-bottom-left', 'cam-pos-bottom-right');
                // Add new
                const pos = btn.dataset.pos;
                els.webcamPreviewLayer.classList.add(`cam-pos-${pos}`);
                camPosition = pos;
            });
        });

        els.camShapeBtn.addEventListener('click', () => {
            if (camShape === 'circle') {
                camShape = 'square';
                els.camShapeBtn.innerHTML = '<i class="fa-solid fa-square"></i>';
                els.webcamPreviewLayer.classList.remove('rounded-full');
                els.webcamPreviewLayer.classList.add('rounded-2xl');
            } else {
                camShape = 'circle';
                els.camShapeBtn.innerHTML = '<i class="fa-solid fa-circle"></i>';
                els.webcamPreviewLayer.classList.remove('rounded-2xl');
                els.webcamPreviewLayer.classList.add('rounded-full');
            }
        });

        // --- STEP 1: Init Stream ---
        els.initBtn.onclick = async () => {
            const useMic = els.micToggle.checked;
            const useCam = els.camToggle.checked;

            try {
                streams.display = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { frameRate: 60, width: { ideal: 1920 }, height: { ideal: 1080 } }, 
                    audio: true 
                });

                if (useMic || useCam) {
                    try {
                        streams.user = await navigator.mediaDevices.getUserMedia({ 
                            audio: useMic, 
                            video: useCam ? { width: 320, height: 240 } : false 
                        });
                    } catch (err) { alert("Medya izni alÄ±namadÄ±."); }
                }

                if (useMic && streams.user && streams.user.getAudioTracks().length > 0) {
                    els.audioPreview.classList.remove('hidden');
                    els.audioPreview.classList.add('flex');
                    initAudioVisualizer(streams.user);
                }
                
                if (useCam && streams.user && streams.user.getVideoTracks().length > 0) {
                    els.camControls.classList.remove('hidden');
                    els.camControls.classList.add('flex');
                    
                    els.webcamPreviewLayer.classList.remove('hidden');
                    els.webcamLiveFeed.srcObject = streams.user;
                } else {
                    els.webcamPreviewLayer.classList.add('hidden');
                }

                els.setupPanel.classList.add('hidden');
                setupCropUI();

            } catch (err) {
                console.warn(err);
                els.setupPanel.classList.remove('hidden');
            }
        };

        // Audio Visualizer Logic
        function initAudioVisualizer(stream) {
            audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 32;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            updateVisualizer();
        }

        function updateVisualizer() {
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            for(let i = 0; i < 5; i++) {
                const val = dataArray[i * 2]; 
                const h = Math.max(4, (val / 255) * 20); 
                els.audioMeters[i].style.height = `${h}px`;
                if (val > 100) els.audioMeters[i].classList.add('active');
                else els.audioMeters[i].classList.remove('active');
            }
            animationId = requestAnimationFrame(updateVisualizer);
        }

        // --- Preview Logic ---
        function setupCropUI() {
            els.cropOverlay.classList.remove('hidden');
            els.cropSourceVideo.srcObject = streams.display;
            
            els.cropSourceVideo.onloadedmetadata = () => {
                const vidW = els.cropSourceVideo.videoWidth;
                const vidH = els.cropSourceVideo.videoHeight;
                
                // FORCE DEFAULT FULL SCREEN MODE
                isCropMode = false;
                updateCropBoxMode(); 
                
                cropState = { sx: 0, sy: 0, sw: vidW, sh: vidH };
            };
        }

        // Draggable Logic
        let isDraggingBox = false;
        let isResizing = false;
        let resizeDir = '';
        let startX, startY, startLeft, startTop, startW, startH;

        els.cropContainer.addEventListener('mousedown', (e) => {
            if(!isCropMode) return; 
            
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                resizeDir = e.target.dataset.dir;
                startX = e.clientX; startY = e.clientY;
                startW = els.cropBox.offsetWidth; startH = els.cropBox.offsetHeight;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            } else if (e.target.id === 'crop-box' || els.cropBox.contains(e.target)) {
                if(mediaRecorder && mediaRecorder.state === 'recording') return;
                isDraggingBox = true;
                startX = e.clientX; startY = e.clientY;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            }
        });

        window.addEventListener('mousemove', (e) => {
            if(!isCropMode) return;
            const containerRect = els.cropContainer.getBoundingClientRect();
            
            if (isDraggingBox) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                let newLeft = Math.max(0, Math.min(startLeft + dx, containerRect.width - els.cropBox.offsetWidth));
                let newTop = Math.max(0, Math.min(startTop + dy, containerRect.height - els.cropBox.offsetHeight));
                
                els.cropBox.style.left = `${newLeft}px`;
                els.cropBox.style.top = `${newTop}px`;
                updateCropLabels();
            } else if (isResizing) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                if (resizeDir.includes('e')) els.cropBox.style.width = `${startW + dx}px`;
                if (resizeDir.includes('s')) els.cropBox.style.height = `${startH + dy}px`;
                updateCropLabels();
            }
        });

        window.addEventListener('mouseup', () => { isDraggingBox = false; isResizing = false; });

        function updateCropLabels() {
            const vidW = els.cropSourceVideo.videoWidth;
            const containerW = els.cropSourceVideo.offsetWidth;
            const scale = vidW / containerW;

            cropState.sx = els.cropBox.offsetLeft * scale;
            cropState.sy = els.cropBox.offsetTop * scale;
            cropState.sw = els.cropBox.offsetWidth * scale;
            cropState.sh = els.cropBox.offsetHeight * scale;
        }

        // --- STEP 2: Start Recording ---
        els.startRecordingBtn.onclick = () => {
            if (isRecording) {
                stopRecording();
                return;
            }

            els.countdownOverlay.classList.remove('hidden');
            let count = 3;
            els.countdownText.innerText = count;
            const cInt = setInterval(() => {
                count--;
                if(count > 0) els.countdownText.innerText = count;
                else {
                    clearInterval(cInt);
                    els.countdownOverlay.classList.add('hidden');
                    beginRecording();
                }
            }, 1000);
        };

        async function beginRecording() {
            isRecording = true;
            els.statusBadge.innerText = "KAYITTA";
            els.statusBadge.className = "text-[10px] uppercase tracking-wider px-2 py-1 rounded border border-red-500 text-red-400 font-bold animate-pulse bg-red-900/20";
            
            els.recordingStatus.classList.remove('hidden');
            els.recordingStatus.classList.remove('ui-hidden'); 
            
            // Hide the Setup Toolbar
            els.cropToolbar.classList.add('hidden');
            
            // Toggle Main Button State
            const btnText = els.startRecordingBtn.querySelector('.btn-text');
            if(btnText) btnText.innerText = "KAYDI DURDUR";
            els.startRecordingBtn.dataset.recording = "true";
            els.startRecordingBtn.classList.replace('bg-red-600', 'bg-slate-700');
            els.startRecordingBtn.onclick = stopRecording; 

            // Visual Guide Mode
            els.cropBox.classList.add('recording-mode');
            document.querySelectorAll('.resize-handle').forEach(h => h.classList.add('hidden'));
            
            if (isCropMode) {
                els.webcamPreviewLayer.classList.add('hidden'); 
            } else {
                els.cropBox.classList.add('hidden');
            }

            const canvas = document.getElementById('compositor-canvas');
            const ctx = canvas.getContext('2d');
            const vScreen = document.getElementById('src-video-screen');
            const vCam = document.getElementById('src-video-cam');

            vScreen.srcObject = streams.display;
            await vScreen.play();

            // Safety check for dimensions
            if (!cropState.sw || cropState.sw <= 0) cropState.sw = vScreen.videoWidth;
            if (!cropState.sh || cropState.sh <= 0) cropState.sh = vScreen.videoHeight;

            canvas.width = cropState.sw;
            canvas.height = cropState.sh;

            // Audio Mixing
            const dest = audioContext ? audioContext.createMediaStreamDestination() : new AudioContext().createMediaStreamDestination();
            const ac = audioContext || new AudioContext(); 
            
            if(streams.display.getAudioTracks().length) ac.createMediaStreamSource(streams.display).connect(dest);
            
            if(streams.user && streams.user.getAudioTracks().length) {
                const ms = ac.createMediaStreamSource(streams.user);
                ms.connect(ac.createGain()).connect(dest);
            }

            const useCam = els.camToggle.checked;
            if (useCam && streams.user) {
                vCam.srcObject = streams.user;
                await vCam.play();
            }

            let isDrawingLoop = true;
            function draw() {
                if(!isDrawingLoop) return;
                
                // --- FIX: Black Background Fill (Fixes dark video on download) ---
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw Crop Area
                ctx.drawImage(vScreen, 
                    cropState.sx, cropState.sy, cropState.sw, cropState.sh, 
                    0, 0, canvas.width, canvas.height
                );

                // --- Webcam Layer ---
                if (useCam && streams.user) {
                    const size = Math.min(canvas.width, canvas.height) * 0.25; 
                    const m = 30;
                    let x, y;

                    // Calculate Cam Position
                    if (camPosition === 'top-left') { x = m; y = m; }
                    else if (camPosition === 'top-right') { x = canvas.width - size - m; y = m; }
                    else if (camPosition === 'bottom-left') { x = m; y = canvas.height - size - m; }
                    else { x = canvas.width - size - m; y = canvas.height - size - m; } // bottom-right

                    ctx.save();
                    ctx.beginPath();
                    
                    if (camShape === 'circle') {
                        ctx.arc(x+size/2, y+size/2, size/2, 0, Math.PI*2);
                    } else {
                        ctx.roundRect(x, y, size, size, 20); 
                    }
                    
                    ctx.clip();
                    ctx.drawImage(vCam, x, y, size, size);
                    ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();
                    ctx.restore();
                }
                requestAnimationFrame(draw);
            }
            draw();

            const finalStream = canvas.captureStream(60);
            if(dest.stream.getAudioTracks().length) finalStream.addTrack(dest.stream.getAudioTracks()[0]);

            let mime = 'video/mp4';
            if(!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm;codecs=vp9';

            mediaRecorder = new MediaRecorder(finalStream, { mimeType: mime });
            recordedChunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                isDrawingLoop = false;
                if (audioContext) audioContext.close();
                if (animationId) cancelAnimationFrame(animationId);
                
                streams.display.getTracks().forEach(t=>t.stop());
                if(streams.user) streams.user.getTracks().forEach(t=>t.stop());
                finalize();
            };
            
            streams.display.getVideoTracks()[0].onended = () => stopRecording();
            mediaRecorder.start();
            
            totalSeconds = 0;
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                if(!isPaused) {
                    totalSeconds++;
                    const m = Math.floor(totalSeconds/60).toString().padStart(2,'0');
                    const s = (totalSeconds%60).toString().padStart(2,'0');
                    els.timer.innerText = `${m}:${s}`;
                    updatePageTitle();
                }
            }, 1000);
        }

        // --- Controls ---
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        }

        function togglePause() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
            
            if(mediaRecorder.state === "recording") {
                mediaRecorder.pause(); isPaused = true;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
                els.pauseBtn.classList.add('text-green-500');
                els.recDotAnim.classList.add('hidden');
                els.recDot.classList.replace('bg-red-500', 'bg-yellow-500');
            } else {
                mediaRecorder.resume(); isPaused = false;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                els.pauseBtn.classList.remove('text-green-500');
                els.recDotAnim.classList.remove('hidden');
                els.recDot.classList.replace('bg-yellow-500', 'bg-red-500');
            }
            updatePageTitle();
        }

        els.stopBtn.onclick = stopRecording;
        els.pauseBtn.onclick = togglePause;

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (!isRecording) return;
            if (e.key === 'F9') {
                e.preventDefault();
                togglePause();
            } else if (e.key === 'F10') {
                e.preventDefault();
                stopRecording();
            }
        });

        function finalize() {
            isRecording = false;
            clearInterval(timerInt);
            updatePageTitle();
            
            // UI TemizliÄŸi
            els.cropToolbar.classList.remove('hidden'); 
            els.recordingStatus.classList.add('hidden');
            els.cropOverlay.classList.add('hidden');
            
            // "HazÄ±rlanÄ±yor" EkranÄ±nÄ± GÃ¶ster
            els.processingOverlay.classList.remove('hidden');
            
            // Ä°ÅŸlemi asenkron yaparak UI'Ä±n donmasÄ±nÄ± engelle ve kullanÄ±cÄ±ya bilgi ver
            setTimeout(() => {
                try {
                    const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
                    recordedBlobUrl = URL.createObjectURL(blob);
                    els.previewVideo.src = recordedBlobUrl;
                    
                    // Video yÃ¼klendiÄŸinde (metadata) iÅŸlem tamamlandÄ± say
                    els.previewVideo.onloadeddata = () => {
                        els.processingOverlay.classList.add('hidden');
                        els.resultPanel.classList.remove('hidden');
                        els.statusBadge.innerText = "TAMAMLANDI";
                        showToast("Video baÅŸarÄ±yla hazÄ±rlandÄ±!");
                    };
                    
                    // Fallback: EÄŸer onloadeddata tetiklenmezse (bazen blob kaynaklarÄ±nda olabilir)
                    // manuel sÃ¼re aÅŸÄ±mÄ± ile aÃ§.
                    setTimeout(() => {
                        if (!els.resultPanel.classList.contains('hidden')) return;
                        els.processingOverlay.classList.add('hidden');
                        els.resultPanel.classList.remove('hidden');
                        els.statusBadge.innerText = "TAMAMLANDI";
                    }, 1000);

                } catch (e) {
                    console.error("Blob oluÅŸturma hatasÄ±:", e);
                    showToast("Video oluÅŸturulurken bir hata oluÅŸtu.");
                    els.processingOverlay.classList.add('hidden');
                }
            }, 1000); // En az 1 saniye bekleme efekti
        }

        function downloadVideo(ext) {
            if(!recordedBlobUrl) return;
            const a = document.createElement('a');
            a.href = recordedBlobUrl;
            a.download = `RecMaster_${Date.now()}.${ext}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        
        document.getElementById('download-mp4').onclick = () => downloadVideo('mp4');
        document.getElementById('download-webm').onclick = () => downloadVideo('webm');
        document.getElementById('new-record-btn').onclick = () => location.reload();

    </script>
</body>
</html>
