<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecMaster Lite: Ekran Kaydedici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        .recording-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Crop Box Styles */
        #crop-container {
            user-select: none;
            touch-action: none;
            overflow: hidden; /* Taşmayı önle */
        }
        /* Düzenleme Modundaki Kutu */
        #crop-box {
            /* İçeriği görebilmek için border yerine outline kullanıyoruz ki boyut hesaplaması şaşmasın */
            /* boxShadow ile karartma efekti veriyoruz */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); 
            cursor: move;
            z-index: 20;
            outline: 2px dashed #ffffff; /* Kesim hattı */
        }
        /* Kayıt Sırasındaki Kılavuz (Recording Guide) */
        #crop-box.recording-mode {
            box-shadow: none; /* Karartmayı kaldır */
            cursor: default;
            pointer-events: none; /* Tıklamaları arkaya geçir */
            background: transparent;
            /* Kılavuz çizgisini DIŞARI atıyoruz ki videoya girmesin */
            outline: 4px solid rgba(239, 68, 68, 0.8); 
            outline-offset: 1px; /* Videodan 1px uzaklaştır */
            animation: guide-pulse 2s infinite;
        }
        
        @keyframes guide-pulse {
            0% { outline-color: rgba(239, 68, 68, 0.8); }
            50% { outline-color: rgba(239, 68, 68, 0.2); }
            100% { outline-color: rgba(239, 68, 68, 0.8); }
        }

        .resize-handle {
            width: 12px;
            height: 12px;
            background-color: white;
            border: 2px solid #ef4444;
            position: absolute;
            border-radius: 50%;
            z-index: 30;
        }
        /* Corners */
        .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }

        .format-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid #334155;
            background-color: #0f172a;
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .format-btn:hover { background-color: #1e293b; color: white; }
        .format-btn.active {
            background-color: #dc2626;
            color: white;
            border-color: #ef4444;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden select-none">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 h-16 flex items-center px-6 justify-between shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-red-600 to-orange-600 rounded-lg flex items-center justify-center shadow-lg shadow-red-500/20">
                <i class="fa-solid fa-crop-simple text-white text-sm"></i>
            </div>
            <h1 class="font-bold text-lg tracking-wide text-slate-100">RecMaster <span class="text-red-500 font-normal">Lite</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="status-badge" class="text-xs px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 font-medium">Hazır</div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden relative items-center justify-center p-4">
        
        <!-- Toast Notification -->
        <div id="toast" class="hidden absolute top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded shadow-lg z-[90] flex items-center animate-fade-in text-sm font-medium">
            <i class="fa-solid fa-circle-info mr-2"></i> <span id="toast-msg">Mesaj</span>
        </div>
        
        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="hidden absolute inset-0 bg-slate-950/95 z-[80] flex items-center justify-center">
            <div class="text-9xl font-bold text-white animate-ping" id="countdown-text">3</div>
        </div>

        <!-- Crop/Area Selection Overlay (Geliştirilmiş Önizleme Modu) -->
        <div id="crop-overlay" class="hidden absolute inset-0 bg-slate-950 z-[60] flex flex-col">
            <!-- Toolbar -->
            <div class="h-auto py-3 bg-slate-900 border-b border-slate-800 flex flex-col md:flex-row items-center justify-between px-6 shrink-0 gap-4">
                <div class="flex items-center gap-4 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
                    <button type="button" class="format-btn active shrink-0" data-format="fullscreen">
                        <i class="fa-solid fa-expand text-lg"></i> Tam Ekran
                    </button>
                    <button type="button" class="format-btn shrink-0" data-format="shorts">
                        <i class="fa-solid fa-mobile-screen text-lg"></i> Shorts (9:16)
                    </button>
                    <button type="button" class="format-btn shrink-0" data-format="square">
                        <i class="fa-regular fa-square text-lg"></i> Kare (1:1)
                    </button>
                    <button type="button" class="format-btn shrink-0" data-format="custom">
                        <i class="fa-solid fa-crop-simple text-lg"></i> Serbest
                    </button>
                </div>

                <div class="flex items-center gap-4">
                     <div class="text-xs text-slate-400 hidden md:block text-right">
                        <div class="font-bold text-white">Önizleme Modu</div>
                        <span id="crop-size-info">1920x1080</span>
                    </div>
                    <button id="start-recording-btn" class="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-red-900/30 flex items-center gap-2 transition-transform hover:scale-105">
                        <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> KAYDI BAŞLAT
                    </button>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="flex-1 relative bg-black overflow-hidden flex items-center justify-center p-4">
                <div id="crop-container" class="relative shadow-2xl border border-slate-800">
                    <!-- Source Video Preview (Under crop box) -->
                    <video id="crop-source-video" autoplay muted class="block max-w-full max-h-[75vh]"></video>
                    
                    <!-- Draggable Crop Box -->
                    <div id="crop-box" class="absolute hidden" style="top: 0; left: 0; width: 100%; height: 100%;">
                        <!-- Handles are only visible in editing mode -->
                        <div class="resize-handle handle-nw" data-dir="nw"></div>
                        <div class="resize-handle handle-ne" data-dir="ne"></div>
                        <div class="resize-handle handle-sw" data-dir="sw"></div>
                        <div class="resize-handle handle-se" data-dir="se"></div>
                        
                        <!-- Center Crosshair (Visual Aid) -->
                        <div class="absolute top-1/2 left-1/2 w-4 h-4 -mt-2 -ml-2 border-t border-l border-white/50 opacity-50 pointer-events-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 1: Setup Panel -->
        <div id="setup-panel" class="w-full max-w-lg bg-slate-900 rounded-2xl p-8 border border-slate-800 shadow-2xl relative overflow-hidden">
            <div class="absolute -top-24 -right-24 w-48 h-48 bg-red-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-orange-500/10 rounded-full blur-3xl"></div>
            
            <h2 class="text-2xl font-bold text-white mb-2 relative z-10 text-center">RecMaster Lite</h2>
            <p class="text-slate-400 text-sm mb-6 relative z-10 text-center">Ekranınızı seçin, formatı ayarlayın ve kaydedin.</p>

            <div class="space-y-4 relative z-10">
                <!-- Toggle Group -->
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center gap-2 transition-all hover:border-red-500/30">
                        <i class="fa-solid fa-microphone text-2xl text-slate-400 mb-1" id="icon-mic"></i>
                        <span class="text-sm font-medium">Mikrofon</span>
                        <input type="checkbox" id="mic-toggle" class="accent-red-500 mt-1">
                    </label>

                    <label class="cursor-pointer bg-slate-800 hover:bg-slate-750 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center gap-2 transition-all hover:border-red-500/30">
                        <i class="fa-solid fa-camera text-2xl text-slate-400 mb-1" id="icon-cam"></i>
                        <span class="text-sm font-medium">Yüz Kamerası</span>
                        <input type="checkbox" id="cam-toggle" class="accent-red-500 mt-1">
                    </label>
                </div>

                <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 flex items-start gap-2">
                    <i class="fa-solid fa-circle-info mt-0.5 text-blue-400"></i>
                    <span>Sonraki adımda kayıt alanını (Shorts, Tam Ekran vb.) canlı önizleme üzerinde ayarlayabileceksiniz.</span>
                </div>

                <button id="init-btn" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-900/20 transform transition-all active:scale-[0.98] mt-2 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-desktop"></i>
                    Ekranı Seç ve Ayarla
                </button>
            </div>
        </div>

        <!-- Recording Status Bar (Floating) -->
        <div id="recording-status" class="hidden absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-slate-700 pr-2 pl-6 py-2 rounded-full flex items-center gap-6 shadow-2xl z-[80]">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-red-500 rounded-full recording-pulse"></div>
                <span class="font-mono text-xl w-24 tracking-wider" id="timer">00:00</span>
            </div>
            <div class="h-6 w-px bg-slate-700"></div>
            <div class="flex gap-2">
                <button id="pause-btn" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 text-yellow-500 flex items-center justify-center transition-colors" title="Duraklat">
                    <i class="fa-solid fa-pause text-xs"></i>
                </button>
                <button id="stop-btn-top" class="w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center shadow-lg transition-colors" title="Bitir">
                    <i class="fa-solid fa-stop text-xs"></i>
                </button>
            </div>
        </div>

        <!-- VIEW 2: Result & Download Panel -->
        <div id="result-panel" class="hidden w-full h-full flex flex-col items-center justify-center gap-6 animate-fade-in z-30 bg-slate-950 p-6">
            
            <!-- Video Preview Container -->
            <div class="w-full max-w-4xl bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-800 relative group" style="max-height: 70vh;">
                <video id="preview-video" class="w-full h-full object-contain" controls></video>
                <div class="absolute top-4 left-4 bg-black/60 px-3 py-1 rounded text-xs backdrop-blur-sm text-white border border-white/10 pointer-events-none">
                    Sonuç Önizleme
                </div>
            </div>

            <!-- Download Options -->
            <div class="w-full max-w-4xl flex flex-col md:flex-row items-center justify-between gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800">
                <div class="text-sm text-slate-400">
                    <span class="block text-white font-bold mb-1">Kayıt Tamamlandı!</span>
                    Format seçerek videonuzu indirin.
                </div>
                
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button id="download-mp4" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-transform hover:-translate-y-0.5">
                        <i class="fa-brands fa-windows"></i> MP4 İndir
                    </button>
                    <button id="download-webm" class="flex-1 md:flex-none bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-transform hover:-translate-y-0.5">
                        <i class="fa-brands fa-chrome"></i> WebM İndir
                    </button>
                    <div class="w-px h-8 bg-slate-700 mx-2 hidden md:block"></div>
                    <button id="new-record-btn" class="bg-transparent hover:bg-slate-800 text-slate-400 hover:text-white px-4 py-3 rounded-lg transition-colors" title="Yeni Kayıt">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Hidden Video Elements for Composition -->
    <video id="src-video-screen" autoplay muted class="hidden"></video>
    <video id="src-video-cam" autoplay muted class="hidden"></video>
    <canvas id="compositor-canvas" class="hidden"></canvas>

    <script>
        /**
         * RecMaster Lite Logic
         */
        
        // --- Variables ---
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlobUrl = null;
        let timerInt;
        let totalSeconds = 0;
        let isPaused = false;
        let selectedFormat = 'fullscreen'; // fullscreen, shorts, square, custom
        
        // Cropping State
        let cropState = {
            sx: 0, sy: 0, sw: 0, sh: 0, // Source coordinates
            scaleFactor: 1
        };
        
        let streams = {
            display: null,
            user: null
        };

        // --- Elements ---
        const els = {
            setupPanel: document.getElementById('setup-panel'),
            resultPanel: document.getElementById('result-panel'),
            recordingStatus: document.getElementById('recording-status'),
            countdownOverlay: document.getElementById('countdown-overlay'),
            countdownText: document.getElementById('countdown-text'),
            cropOverlay: document.getElementById('crop-overlay'),
            cropSourceVideo: document.getElementById('crop-source-video'),
            cropBox: document.getElementById('crop-box'),
            cropSizeInfo: document.getElementById('crop-size-info'),
            cropContainer: document.getElementById('crop-container'),
            
            initBtn: document.getElementById('init-btn'),
            startRecordingBtn: document.getElementById('start-recording-btn'),
            stopBtn: document.getElementById('stop-btn-top'),
            pauseBtn: document.getElementById('pause-btn'),
            timer: document.getElementById('timer'),
            statusBadge: document.getElementById('status-badge'),
            previewVideo: document.getElementById('preview-video'),
            micToggle: document.getElementById('mic-toggle'),
            camToggle: document.getElementById('cam-toggle'),
            iconMic: document.getElementById('icon-mic'),
            iconCam: document.getElementById('icon-cam')
        };

        // --- UI Interactions ---
        els.micToggle.addEventListener('change', (e) => {
            els.iconMic.className = e.target.checked ? "fa-solid fa-microphone text-2xl text-white mb-1" : "fa-solid fa-microphone text-2xl text-slate-400 mb-1";
        });
        els.camToggle.addEventListener('change', (e) => {
            els.iconCam.className = e.target.checked ? "fa-solid fa-camera text-2xl text-white mb-1" : "fa-solid fa-camera text-2xl text-slate-400 mb-1";
        });

        // Format Selection Logic
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                selectedFormat = btn.dataset.format;
                updateCropBoxFromFormat(); // Format değişince kutuyu güncelle
            });
        });

        // --- STEP 1: Initialize Stream & Open Preview ---
        els.initBtn.onclick = async () => {
            const useMic = els.micToggle.checked;
            const useCam = els.camToggle.checked;

            try {
                // 1. Get Screen Stream
                streams.display = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { frameRate: 60, width: { ideal: 1920 }, height: { ideal: 1080 } }, 
                    audio: true 
                });

                // 2. Get User Stream
                if (useMic || useCam) {
                    try {
                        streams.user = await navigator.mediaDevices.getUserMedia({ 
                            audio: useMic, 
                            video: useCam ? { width: 320, height: 240 } : false 
                        });
                    } catch (err) {
                        alert("Kamera/Mikrofon izni alınamadı.");
                    }
                }

                els.setupPanel.classList.add('hidden');
                setupCropUI(); // Direkt Önizlemeyi Aç

            } catch (err) {
                console.warn("Cancelled:", err);
                els.setupPanel.classList.remove('hidden');
            }
        };

        // --- Crop UI Logic ---
        function setupCropUI() {
            els.cropOverlay.classList.remove('hidden');
            els.cropSourceVideo.srcObject = streams.display;
            
            els.cropSourceVideo.onloadedmetadata = () => {
                updateCropBoxFromFormat();
            };
        }

        // Apply Format Dimensions to Crop Box
        function updateCropBoxFromFormat() {
            if (!els.cropSourceVideo.videoWidth) return;

            const vidW = els.cropSourceVideo.videoWidth;
            const vidH = els.cropSourceVideo.videoHeight;
            
            // Container visual dimensions
            const containerW = els.cropSourceVideo.offsetWidth;
            const containerH = els.cropSourceVideo.offsetHeight;
            const scale = containerW / vidW; // Scale ratio for visual elements
            
            // Eğer tam ekransa kutuyu gizle
            if (selectedFormat === 'fullscreen') {
                els.cropBox.classList.add('hidden');
                updateCropLabels(); // Full size güncelle
                return;
            } else {
                els.cropBox.classList.remove('hidden');
            }

            // Calculate Target Size (in video pixels)
            let boxW, boxH;

            if (selectedFormat === 'shorts') { // 9:16
                boxH = vidH * 0.9;
                boxW = boxH * (9/16);
            } else if (selectedFormat === 'square') { // 1:1
                boxH = vidH * 0.8;
                boxW = boxH;
            } else { // Custom (Default to 50%)
                boxW = vidW * 0.5;
                boxH = vidH * 0.5;
            }

            // Convert to Display Pixels
            const dispW = boxW * scale;
            const dispH = boxH * scale;

            // Center it
            const left = (containerW - dispW) / 2;
            const top = (containerH - dispH) / 2;

            els.cropBox.style.width = `${dispW}px`;
            els.cropBox.style.height = `${dispH}px`;
            els.cropBox.style.left = `${left}px`;
            els.cropBox.style.top = `${top}px`;

            updateCropLabels();
        }

        // Draggable Logic
        let isDraggingBox = false;
        let isResizing = false;
        let resizeDir = '';
        let startX, startY, startLeft, startTop, startW, startH;

        els.cropContainer.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('resize-handle')) {
                if (selectedFormat !== 'custom') return;
                isResizing = true;
                resizeDir = e.target.dataset.dir;
                startX = e.clientX; startY = e.clientY;
                startW = els.cropBox.offsetWidth; startH = els.cropBox.offsetHeight;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            } else if (e.target.id === 'crop-box' || els.cropBox.contains(e.target)) {
                // Recording mode check: Don't drag if recording!
                if(mediaRecorder && mediaRecorder.state === 'recording') return;
                
                isDraggingBox = true;
                startX = e.clientX; startY = e.clientY;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            }
        });

        window.addEventListener('mousemove', (e) => {
            const containerRect = els.cropContainer.getBoundingClientRect();
            
            if (isDraggingBox) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                let newLeft = Math.max(0, Math.min(startLeft + dx, containerRect.width - els.cropBox.offsetWidth));
                let newTop = Math.max(0, Math.min(startTop + dy, containerRect.height - els.cropBox.offsetHeight));
                
                els.cropBox.style.left = `${newLeft}px`;
                els.cropBox.style.top = `${newTop}px`;
                updateCropLabels();
            } else if (isResizing) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                
                if (resizeDir.includes('e')) els.cropBox.style.width = `${startW + dx}px`;
                if (resizeDir.includes('s')) els.cropBox.style.height = `${startH + dy}px`;
                updateCropLabels();
            }
        });

        window.addEventListener('mouseup', () => { isDraggingBox = false; isResizing = false; });

        function updateCropLabels() {
            // Real video dims
            const vidW = els.cropSourceVideo.videoWidth;
            const containerW = els.cropSourceVideo.offsetWidth;
            const scale = vidW / containerW;

            if (selectedFormat === 'fullscreen') {
                cropState = { sx: 0, sy: 0, sw: vidW, sh: els.cropSourceVideo.videoHeight };
                els.cropSizeInfo.innerText = `${vidW}x${els.cropSourceVideo.videoHeight}`;
            } else {
                cropState.sx = els.cropBox.offsetLeft * scale;
                cropState.sy = els.cropBox.offsetTop * scale;
                cropState.sw = els.cropBox.offsetWidth * scale;
                cropState.sh = els.cropBox.offsetHeight * scale;
                els.cropSizeInfo.innerText = `${Math.round(cropState.sw)}x${Math.round(cropState.sh)}`;
            }
        }

        // --- STEP 2: Start Recording ---
        els.startRecordingBtn.onclick = () => {
            // Start Countdown
            els.countdownOverlay.classList.remove('hidden');
            let count = 3;
            els.countdownText.innerText = count;
            const cInt = setInterval(() => {
                count--;
                if(count > 0) els.countdownText.innerText = count;
                else {
                    clearInterval(cInt);
                    els.countdownOverlay.classList.add('hidden');
                    beginRecording();
                }
            }, 1000);
        };

        async function beginRecording() {
            // UI Transition
            els.statusBadge.innerText = "KAYITTA";
            els.statusBadge.className = "text-xs px-3 py-1 rounded-full bg-red-900/50 border border-red-500 text-red-400 font-bold animate-pulse";
            els.recordingStatus.classList.remove('hidden');
            
            // Change Crop Box to "Recording Guide" Mode
            if (selectedFormat !== 'fullscreen') {
                els.cropBox.classList.add('recording-mode');
                // Hide handles
                document.querySelectorAll('.resize-handle').forEach(h => h.classList.add('hidden'));
            } else {
                // If fullscreen, ensure box is hidden
                els.cropBox.classList.add('hidden');
            }

            // Canvas & Video Setup
            const canvas = document.getElementById('compositor-canvas');
            const ctx = canvas.getContext('2d');
            const vScreen = document.getElementById('src-video-screen');
            const vCam = document.getElementById('src-video-cam');

            vScreen.srcObject = streams.display;
            await vScreen.play();

            // Set Canvas to Crop Size
            canvas.width = cropState.sw;
            canvas.height = cropState.sh;

            // Audio Mixing
            const ac = new AudioContext();
            const dest = ac.createMediaStreamDestination();
            if(streams.display.getAudioTracks().length) ac.createMediaStreamSource(streams.display).connect(dest);
            if(streams.user && streams.user.getAudioTracks().length) {
                const ms = ac.createMediaStreamSource(streams.user);
                const g = ac.createGain(); g.gain.value = 1.5;
                ms.connect(g).connect(dest);
            }

            // Draw Loop
            const useCam = els.camToggle.checked;
            if (useCam && streams.user) {
                vCam.srcObject = streams.user;
                await vCam.play();
            }

            let isDrawing = true;
            function draw() {
                if(!isDrawing) return;
                
                // Draw Crop Area Only
                ctx.drawImage(vScreen, 
                    cropState.sx, cropState.sy, cropState.sw, cropState.sh, 
                    0, 0, canvas.width, canvas.height
                );

                // Facecam Logic (Relative to crop)
                if (useCam && streams.user) {
                    const size = canvas.height * 0.2; 
                    const m = 20;
                    const x = canvas.width - size - m;
                    const y = canvas.height - size - m;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x+size/2, y+size/2, size/2, 0, Math.PI*2);
                    ctx.clip();
                    ctx.drawImage(vCam, x, y, size, size);
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
                    ctx.restore();
                }
                requestAnimationFrame(draw);
            }
            draw();

            // Record
            const finalStream = canvas.captureStream(60);
            if(dest.stream.getAudioTracks().length) finalStream.addTrack(dest.stream.getAudioTracks()[0]);

            let mime = 'video/mp4';
            if(!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm;codecs=vp9';

            mediaRecorder = new MediaRecorder(finalStream, { mimeType: mime });
            recordedChunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                isDrawing = false;
                ac.close();
                streams.display.getTracks().forEach(t=>t.stop());
                if(streams.user) streams.user.getTracks().forEach(t=>t.stop());
                finalize();
            };
            
            // Native stop
            streams.display.getVideoTracks()[0].onended = () => mediaRecorder.stop();

            mediaRecorder.start();
            
            // Timer
            totalSeconds = 0;
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                if(!isPaused) {
                    totalSeconds++;
                    const m = Math.floor(totalSeconds/60).toString().padStart(2,'0');
                    const s = (totalSeconds%60).toString().padStart(2,'0');
                    els.timer.innerText = `${m}:${s}`;
                }
            }, 1000);
        }

        // --- Controls ---
        els.stopBtn.onclick = () => mediaRecorder.stop();
        els.pauseBtn.onclick = () => {
            if(mediaRecorder.state === "recording") {
                mediaRecorder.pause(); isPaused = true;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
                els.pauseBtn.classList.add('text-green-500');
            } else {
                mediaRecorder.resume(); isPaused = false;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                els.pauseBtn.classList.remove('text-green-500');
            }
        };

        function finalize() {
            clearInterval(timerInt);
            els.recordingStatus.classList.add('hidden');
            els.cropOverlay.classList.add('hidden'); // Kılavuz ekranını kapat
            els.resultPanel.classList.remove('hidden');
            els.statusBadge.innerText = "TAMAMLANDI";
            els.statusBadge.className = "text-xs px-3 py-1 rounded-full bg-green-900/50 border border-green-500 text-green-400 font-bold";
            
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            recordedBlobUrl = URL.createObjectURL(blob);
            els.previewVideo.src = recordedBlobUrl;
        }

        function downloadVideo(ext) {
            if(!recordedBlobUrl) return;
            const a = document.createElement('a');
            a.href = recordedBlobUrl;
            a.download = `RecMaster_${selectedFormat}_${Date.now()}.${ext}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        
        document.getElementById('download-mp4').onclick = () => downloadVideo('mp4');
        document.getElementById('download-webm').onclick = () => downloadVideo('webm');
        document.getElementById('new-record-btn').onclick = () => location.reload();

    </script>
</body>
</html>
