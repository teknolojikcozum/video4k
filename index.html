<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecMaster Studio: KayÄ±t & DÃ¼zenleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .recording-pulse {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-bar { transition: height 0.1s ease; }
        .countdown-anim { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Timeline Styles */
        .timeline-track {
            background-image: repeating-linear-gradient(45deg, #374151 25%, transparent 25%, transparent 75%, #374151 75%, #374151), repeating-linear-gradient(45deg, #374151 25%, #1f2937 25%, #1f2937 75%, #374151 75%, #374151);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        /* Custom Range Slider Styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 4px;
            background: #ffffff;
            margin-top: -10px;
            cursor: ew-resize;
            border-radius: 0px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            position: relative;
            z-index: 50;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent; /* Track handled manually */
        }
        .layer-item.active {
            border-left: 4px solid #3b82f6;
            background-color: #1e293b;
        }
    </style>
</head>
<body class="bg-slate-950 text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 p-3 z-20 shrink-0">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-red-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/20">
                    <i class="fa-solid fa-film text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">RecMaster <span class="text-purple-400">Studio</span></h1>
                </div>
            </div>
            <div class="flex gap-4 text-xs text-slate-400">
                <span id="mode-indicator" class="bg-slate-800 px-2 py-1 rounded border border-slate-700">KayÄ±t Modu</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- Toast Notification -->
        <div id="toast" class="hidden absolute top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded shadow-lg z-50 flex items-center animate-fade-in">
            <i class="fa-solid fa-info-circle mr-2"></i>
            <span id="toast-msg">Bilgi mesajÄ±</span>
        </div>

        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="hidden absolute inset-0 bg-slate-950/95 z-50 flex items-center justify-center">
            <div class="text-9xl font-bold text-white countdown-anim" id="countdown-text">3</div>
        </div>

        <!-- Recording Status Bar (Floating) -->
        <div id="recording-status" class="hidden absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-slate-700 px-6 py-3 rounded-full flex items-center gap-6 shadow-2xl z-40 transition-all">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-red-500 rounded-full recording-pulse" id="rec-dot"></div>
                <span class="font-mono text-xl w-24" id="timer">00:00:00</span>
            </div>
            <div class="h-8 w-px bg-slate-700"></div>
            <div class="flex gap-2">
                <button id="pause-btn" class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-yellow-400 rounded-full transition-colors">
                    <i class="fa-solid fa-pause" id="pause-icon"></i>
                </button>
                <button id="stop-btn-top" class="w-10 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-full transition-colors shadow-lg shadow-red-500/30">
                    <i class="fa-solid fa-stop"></i>
                </button>
            </div>
        </div>

        <!-- VIEW 1: Setup Panel -->
        <div id="setup-panel" class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-3xl bg-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-800 text-center relative overflow-hidden">
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl"></div>
                <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-red-600/10 rounded-full blur-3xl"></div>
                
                <h2 class="text-3xl font-bold mb-2 relative z-10">StÃ¼dyonu HazÄ±rla</h2>
                <p class="text-slate-400 mb-8 relative z-10">KayÄ±t yapÄ±n, ardÄ±ndan dahili editÃ¶rde kesin ve dÃ¼zenleyin.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 relative z-10">
                    <!-- Microphone -->
                    <label class="cursor-pointer bg-slate-800/50 hover:bg-slate-800 border border-slate-700 rounded-xl p-4 flex items-center justify-between transition-all group select-none">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition-colors">
                                <i class="fa-solid fa-microphone text-lg text-blue-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">Mikrofon</div>
                                <div class="text-xs text-slate-400">Sesli anlatÄ±m</div>
                            </div>
                        </div>
                        <input type="checkbox" id="mic-toggle" class="w-5 h-5 accent-blue-500">
                    </label>

                    <!-- Camera -->
                    <label class="cursor-pointer bg-slate-800/50 hover:bg-slate-800 border border-slate-700 rounded-xl p-4 flex items-center justify-between transition-all group select-none">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition-colors">
                                <i class="fa-solid fa-camera text-lg text-purple-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">YÃ¼z KamerasÄ±</div>
                                <div class="text-xs text-slate-400">SaÄŸ alt kÃ¶ÅŸe</div>
                            </div>
                        </div>
                        <input type="checkbox" id="cam-toggle" class="w-5 h-5 accent-purple-500">
                    </label>
                </div>

                <button id="start-btn" class="w-full bg-gradient-to-r from-red-600 to-purple-600 hover:from-red-500 hover:to-purple-500 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-purple-900/40 transform transition-all hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-3 relative z-10">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-circle text-white text-xs"></i>
                    </div>
                    KaydÄ± BaÅŸlat
                </button>
            </div>
        </div>

        <!-- VIEW 2: Editor Panel (Initially Hidden) -->
        <div id="editor-panel" class="hidden flex-1 flex flex-col h-full animate-fade-in">
            
            <!-- Editor Toolbar -->
            <div class="bg-slate-900 border-b border-slate-800 p-2 flex flex-wrap justify-between items-center shrink-0 gap-2">
                <div class="flex items-center gap-2">
                    <!-- Editing Tools -->
                    <div class="flex bg-slate-800 rounded border border-slate-700 overflow-hidden">
                        <button id="set-in-btn" class="px-3 py-1.5 hover:bg-slate-700 text-slate-300 border-r border-slate-700 text-xs" title="BaÅŸlangÄ±Ã§ NoktasÄ± (In)">
                            <i class="fa-solid fa-bracket-left mr-1"></i> BaÅŸlangÄ±Ã§
                        </button>
                        <button id="set-out-btn" class="px-3 py-1.5 hover:bg-slate-700 text-slate-300 border-r border-slate-700 text-xs" title="BitiÅŸ NoktasÄ± (Out)">
                             BitiÅŸ <i class="fa-solid fa-bracket-right ml-1"></i>
                        </button>
                        <button id="reset-trim-btn" class="px-3 py-1.5 hover:bg-slate-700 text-red-400 text-xs" title="Kesimi SÄ±fÄ±rla">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <div class="h-6 w-px bg-slate-700 mx-1"></div>

                    <button id="add-text-btn" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded text-xs flex items-center gap-2 border border-slate-700 transition-colors">
                        <i class="fa-solid fa-font"></i> YazÄ±
                    </button>
                    
                    <div class="relative group">
                         <select id="speed-select" class="bg-slate-800 hover:bg-slate-700 text-white px-2 py-1.5 rounded text-xs border border-slate-700 appearance-none cursor-pointer pr-6">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                        <i class="fa-solid fa-gauge-high absolute right-2 top-1/2 -translate-y-1/2 text-xs text-slate-400 pointer-events-none"></i>
                    </div>

                    <button id="snapshot-btn" class="bg-slate-800 hover:bg-slate-700 text-blue-400 px-3 py-1.5 rounded text-xs flex items-center gap-2 border border-slate-700 transition-colors" title="Ekran GÃ¶rÃ¼ntÃ¼sÃ¼ Al">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>

                <div class="flex items-center gap-2">
                     <button id="new-record-btn" class="text-slate-400 hover:text-white px-3 py-1 text-xs">
                        <i class="fa-solid fa-trash mr-1"></i> Sil
                    </button>
                    <button id="export-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white px-4 py-1.5 rounded text-sm font-bold flex items-center gap-2 shadow-lg shadow-green-900/20 transition-all">
                        <i class="fa-solid fa-download"></i> Videoyu Ã‡Ä±kar
                    </button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden">
                <!-- Left: Canvas Area -->
                <div class="flex-1 bg-black flex items-center justify-center relative group p-4 bg-[radial-gradient(#222_1px,transparent_1px)] [background-size:16px_16px]">
                    <canvas id="editor-canvas" class="max-w-full max-h-full shadow-2xl border border-slate-800"></canvas>
                    
                    <!-- Canvas Controls Overlay -->
                    <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-900/80 backdrop-blur px-4 py-2 rounded-full flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button id="editor-play-btn" class="text-white hover:text-blue-400 text-xl w-8 h-8 flex items-center justify-center transition-transform hover:scale-110">
                            <i class="fa-solid fa-play"></i>
                        </button>
                        <span id="editor-time" class="font-mono text-sm w-16 text-center">00:00</span>
                    </div>
                </div>

                <!-- Right: Properties Panel -->
                <div class="w-64 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0">
                    <div class="p-3 border-b border-slate-800 font-bold text-xs text-slate-300 uppercase tracking-wider">
                        Katman AyarlarÄ±
                    </div>
                    
                    <!-- Selected Layer Properties -->
                    <div id="layer-props" class="p-4 border-b border-slate-800 hidden bg-slate-800/30">
                        <label class="block text-xs text-slate-500 mb-1">Metin</label>
                        <input type="text" id="prop-text" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm mb-3 focus:border-blue-500 outline-none">
                        
                        <div class="flex gap-2 mb-3">
                            <div class="flex-1">
                                <label class="block text-xs text-slate-500 mb-1">Renk</label>
                                <input type="color" id="prop-color" class="w-full h-8 bg-transparent cursor-pointer rounded border border-slate-700">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-slate-500 mb-1">Boyut (px)</label>
                                <input type="number" id="prop-size" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm" min="10" max="200">
                            </div>
                        </div>
                        <button id="delete-layer-btn" class="w-full bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 rounded py-1.5 text-xs transition-colors">
                            <i class="fa-solid fa-trash mr-1"></i> KatmanÄ± Sil
                        </button>
                    </div>
                    
                    <!-- Layers List -->
                    <div id="layers-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- Dynamic content -->
                        <div class="text-center text-xs text-slate-600 mt-10 italic">YazÄ± katmanÄ± yok.</div>
                    </div>
                </div>
            </div>

            <!-- Bottom: Timeline -->
            <div class="h-auto bg-slate-900 border-t border-slate-800 shrink-0 flex flex-col">
                <!-- Time Scrubber & Trim Visualization -->
                <div class="h-8 bg-slate-950 border-b border-slate-800 flex items-center px-4 relative group">
                    <!-- Trim Areas (Visual) -->
                    <div class="absolute top-0 bottom-0 left-4 right-4 pointer-events-none">
                        <!-- Left Trimmed Area (Grayed out) -->
                        <div id="trim-visual-left" class="absolute left-0 top-0 bottom-0 bg-black/70 z-0 w-0 border-r border-red-500/50"></div>
                        <!-- Active Area (Blue hint) -->
                        <div id="trim-visual-active" class="absolute left-0 right-0 top-0 bottom-0 bg-blue-500/5 z-0"></div>
                        <!-- Right Trimmed Area (Grayed out) -->
                        <div id="trim-visual-right" class="absolute right-0 top-0 bottom-0 bg-black/70 z-0 w-0 border-l border-red-500/50"></div>
                    </div>

                    <!-- Range Input -->
                    <input type="range" id="timeline-scrubber" min="0" max="100" value="0" step="0.1" class="w-full h-full opacity-0 absolute inset-0 z-20 cursor-pointer">
                    
                    <!-- Custom Scrubber Track -->
                    <div id="scrubber-track" class="w-full h-1 bg-slate-700 relative rounded pointer-events-none z-10">
                        <div id="scrubber-fill" class="h-full bg-blue-500 w-0 rounded"></div>
                        <div id="scrubber-thumb" class="w-1 h-4 bg-white absolute top-1/2 transform -translate-y-1/2 shadow-lg -ml-0.5" style="left: 0%"></div>
                    </div>
                </div>

                <!-- Tracks -->
                <div class="h-32 overflow-y-auto p-2 space-y-1 custom-scrollbar bg-slate-900">
                    <!-- Video Track -->
                    <div class="flex items-center h-8 bg-slate-800/50 rounded border border-slate-700 overflow-hidden relative timeline-track">
                        <div class="w-20 bg-slate-800 h-full flex items-center justify-center border-r border-slate-700 text-xs font-bold text-blue-400 z-10">VIDEO</div>
                        <div class="flex-1 h-full relative">
                            <div class="absolute inset-0 bg-blue-900/20 flex items-center justify-center text-xs text-blue-300/40 tracking-widest">
                                <i class="fa-solid fa-video mr-2"></i> ANA KAYIT
                            </div>
                        </div>
                    </div>

                     <!-- Audio Track -->
                     <div class="flex items-center h-8 bg-slate-800/50 rounded border border-slate-700 overflow-hidden relative timeline-track">
                        <div class="w-20 bg-slate-800 h-full flex items-center justify-center border-r border-slate-700 text-xs font-bold text-green-400 z-10">SES</div>
                        <div class="flex-1 h-full relative">
                             <div class="absolute inset-0 bg-green-900/20 flex items-center overflow-hidden opacity-50">
                                <div class="w-full h-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjEwIj48cmVjdCB3aWR0aD0iMiIgaGVpZ2h0PSI2IiB4PSIxIiB5PSIyIiBmaWxsPSIjNGFkZThjIiAvPjwvc3ZnPg==')] opacity-50"></div>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Text Tracks Container -->
                    <div id="text-tracks-area" class="space-y-1"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: Rendering Overlay -->
        <div id="render-overlay" class="hidden absolute inset-0 bg-slate-950/95 z-50 flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-6"></div>
            <h2 class="text-2xl font-bold mb-2">Video Ä°ÅŸleniyor...</h2>
            <p class="text-slate-400 mb-6">KÄ±rpma ve efektler uygulanÄ±yor. LÃ¼tfen bekleyin.</p>
            <div class="w-64 h-2 bg-slate-800 rounded overflow-hidden">
                <div id="render-progress" class="h-full bg-green-500 w-0 transition-all duration-100"></div>
            </div>
            <p id="render-status" class="text-xs text-slate-500 mt-2">0%</p>
        </div>

    </main>
    
    <!-- Hidden Elements -->
    <video id="src-video-screen" autoplay muted class="hidden"></video>
    <video id="src-video-cam" autoplay muted class="hidden"></video>
    <!-- Source for Editor (Hidden) -->
    <video id="editor-source-video" class="hidden" playsinline></video>
    <!-- Hidden canvas for render capturing -->
    <canvas id="compositor-canvas" class="hidden"></canvas>

    <!-- Script Logic -->
    <script>
        // --- CORE VARIABLES ---
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlobUrl = null;
        let recordingStream = null;
        let audioContext;
        let isRecording = false;
        let timerInterval;
        let totalSeconds = 0;
        
        // --- EDITOR VARIABLES ---
        let editorCanvas = document.getElementById('editor-canvas');
        let editorCtx = editorCanvas.getContext('2d');
        let editorVideo = document.getElementById('editor-source-video');
        let textLayers = []; 
        let selectedLayerId = null;
        let isEditorPlaying = false;
        let animationFrameId;
        let videoDuration = 0;
        let isDragging = false;
        let dragTargetId = null;
        
        // --- TRIM & EDIT VARIABLES ---
        let trimStartTime = 0;
        let trimEndTime = 0;
        let playbackSpeed = 1.0;

        // --- DOM ELEMENTS ---
        const startBtn = document.getElementById('start-btn');
        const setupPanel = document.getElementById('setup-panel');
        const editorPanel = document.getElementById('editor-panel');
        const renderOverlay = document.getElementById('render-overlay');
        const micToggle = document.getElementById('mic-toggle');
        const camToggle = document.getElementById('cam-toggle');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-msg');

        // Helper: Toast
        function showToast(msg) {
            toastMsg.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ==========================================
        // PART 1: RECORDING LOGIC
        // ==========================================

        startBtn.addEventListener('click', async () => {
            try {
                // 1. Get Screen
                const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 60 }, audio: true });
                
                // 2. Get User Media
                const useMic = micToggle.checked;
                const useCam = camToggle.checked;
                let userStream = null;

                if (useMic || useCam) {
                    try {
                        userStream = await navigator.mediaDevices.getUserMedia({
                            audio: useMic,
                            video: useCam ? { width: 320, height: 240 } : false
                        });
                    } catch (e) {
                        showToast("Kamera/Mikrofon izni alÄ±namadÄ±.");
                    }
                }

                // 3. Start Countdown
                setupPanel.classList.add('hidden');
                document.getElementById('countdown-overlay').classList.remove('hidden');
                let count = 3;
                const cInt = setInterval(() => {
                    count--;
                    document.getElementById('countdown-text').innerText = count;
                    if (count <= 0) {
                        clearInterval(cInt);
                        document.getElementById('countdown-overlay').classList.add('hidden');
                        startRecording(displayStream, userStream, useCam);
                    }
                }, 1000);

            } catch (err) {
                console.warn(err);
            }
        });

        async function startRecording(displayStream, userStream, useCam) {
            const canvas = document.getElementById('compositor-canvas');
            const ctx = canvas.getContext('2d');
            const srcScreen = document.getElementById('src-video-screen');
            const srcCam = document.getElementById('src-video-cam');
            
            srcScreen.srcObject = displayStream;
            await srcScreen.play();
            canvas.width = srcScreen.videoWidth;
            canvas.height = srcScreen.videoHeight;

            let finalStream;
            
            // Audio Mixing
            const ac = new AudioContext();
            const dest = ac.createMediaStreamDestination();
            if(displayStream.getAudioTracks().length) ac.createMediaStreamSource(displayStream).connect(dest);
            if(userStream && userStream.getAudioTracks().length) {
                const ms = ac.createMediaStreamSource(userStream);
                const g = ac.createGain(); g.gain.value = 1.5;
                ms.connect(g).connect(dest);
            }

            // Compositor Loop
            if (useCam && userStream && userStream.getVideoTracks().length) {
                srcCam.srcObject = userStream;
                await srcCam.play();
                
                function draw() {
                    if(!isRecording) return;
                    ctx.drawImage(srcScreen, 0, 0, canvas.width, canvas.height);
                    // Facecam (Circle Bottom Right)
                    const s = canvas.height * 0.25;
                    const p = 30;
                    const x = canvas.width - s - p;
                    const y = canvas.height - s - p;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x + s/2, y + s/2, s/2, 0, Math.PI*2);
                    ctx.clip();
                    ctx.drawImage(srcCam, x, y, s, s);
                    ctx.strokeStyle = "white"; ctx.lineWidth = 5; ctx.stroke();
                    ctx.restore();
                    requestAnimationFrame(draw);
                }
                isRecording = true;
                draw();
                finalStream = canvas.captureStream(60);
            } else {
                finalStream = displayStream; // Just screen
                isRecording = true;
            }

            // Merge Audio
            if (dest.stream.getAudioTracks().length) {
                finalStream.addTrack(dest.stream.getAudioTracks()[0]);
            }

            // Recorder
            mediaRecorder = new MediaRecorder(finalStream, { mimeType: 'video/webm;codecs=vp9' });
            recordedChunks = [];
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                isRecording = false;
                // Cleanup
                displayStream.getTracks().forEach(t=>t.stop());
                if(userStream) userStream.getTracks().forEach(t=>t.stop());
                ac.close();
                
                // Go to Editor
                initEditor();
            };

            // Native Stop
            displayStream.getVideoTracks()[0].onended = () => mediaRecorder.stop();

            mediaRecorder.start();
            document.getElementById('recording-status').classList.remove('hidden');
            document.getElementById('mode-indicator').innerText = "ðŸ”´ KAYITTA";
            document.getElementById('mode-indicator').classList.add('text-red-400', 'border-red-900');
            
            // Timer
            totalSeconds = 0;
            timerInterval = setInterval(() => {
                totalSeconds++;
                const m = Math.floor(totalSeconds/60).toString().padStart(2,'0');
                const s = (totalSeconds%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `00:${m}:${s}`;
            }, 1000);
        }

        document.getElementById('stop-btn-top').onclick = () => mediaRecorder.stop();
        
        // ==========================================
        // PART 2: EDITOR LOGIC
        // ==========================================

        function initEditor() {
            clearInterval(timerInterval);
            document.getElementById('recording-status').classList.add('hidden');
            setupPanel.classList.add('hidden');
            editorPanel.classList.remove('hidden');
            document.getElementById('mode-indicator').innerText = "ðŸŽ¬ STÃœDYO";
            document.getElementById('mode-indicator').className = "bg-blue-900/30 px-2 py-1 rounded border border-blue-800 text-blue-400";

            // Load Video
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            recordedBlobUrl = URL.createObjectURL(blob);
            editorVideo.src = recordedBlobUrl;
            
            editorVideo.onloadedmetadata = () => {
                videoDuration = editorVideo.duration;
                trimEndTime = videoDuration; // Default: Full length
                
                // Set canvas size to match video
                editorCanvas.width = editorVideo.videoWidth;
                editorCanvas.height = editorVideo.videoHeight;
                drawEditorFrame();
                updateTimelineVisuals();
            };
        }

        // --- TRIM & PLAYBACK LOGIC ---
        const playBtn = document.getElementById('editor-play-btn');
        const scrubber = document.getElementById('timeline-scrubber');
        
        playBtn.onclick = togglePlay;
        
        // Loop or Stop at Trim End
        editorVideo.addEventListener('timeupdate', () => {
            if (isEditorPlaying) {
                // If we pass the trim end, loop back to start
                if (editorVideo.currentTime >= trimEndTime) {
                    editorVideo.currentTime = trimStartTime;
                    // Optional: Pause instead of loop -> togglePlay();
                }
            }
            // Update UI if playing
            if(isEditorPlaying) updateTimelineUI();
        });

        function togglePlay() {
            if (isEditorPlaying) {
                editorVideo.pause();
                isEditorPlaying = false;
                cancelAnimationFrame(animationFrameId);
                playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
            } else {
                // If playhead is out of bounds, jump to start
                if (editorVideo.currentTime < trimStartTime || editorVideo.currentTime >= trimEndTime) {
                    editorVideo.currentTime = trimStartTime;
                }
                editorVideo.playbackRate = playbackSpeed;
                editorVideo.play();
                isEditorPlaying = true;
                drawEditorFrame();
                playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            }
        }

        // Scrubber Logic
        scrubber.addEventListener('input', (e) => {
            const pct = e.target.value;
            const time = (pct / 100) * videoDuration;
            editorVideo.currentTime = time;
            if(!isEditorPlaying) {
                drawEditorFrame();
                updateTimelineUI();
            }
        });

        // Trim Controls
        document.getElementById('set-in-btn').onclick = () => {
            if (editorVideo.currentTime >= trimEndTime) {
                showToast("BaÅŸlangÄ±Ã§ noktasÄ± bitiÅŸten sonra olamaz!");
                return;
            }
            trimStartTime = editorVideo.currentTime;
            updateTimelineVisuals();
            showToast("BaÅŸlangÄ±Ã§ kesim noktasÄ± ayarlandÄ±.");
        };

        document.getElementById('set-out-btn').onclick = () => {
             if (editorVideo.currentTime <= trimStartTime) {
                showToast("BitiÅŸ noktasÄ± baÅŸlangÄ±Ã§tan Ã¶nce olamaz!");
                return;
            }
            trimEndTime = editorVideo.currentTime;
            updateTimelineVisuals();
            showToast("BitiÅŸ kesim noktasÄ± ayarlandÄ±.");
        };

        document.getElementById('reset-trim-btn').onclick = () => {
            trimStartTime = 0;
            trimEndTime = videoDuration;
            updateTimelineVisuals();
            showToast("Kesimler sÄ±fÄ±rlandÄ±.");
        };

        document.getElementById('speed-select').onchange = (e) => {
            playbackSpeed = parseFloat(e.target.value);
            if(isEditorPlaying) editorVideo.playbackRate = playbackSpeed;
        };

        document.getElementById('snapshot-btn').onclick = () => {
            // Create a temp link to download current canvas state
            const link = document.createElement('a');
            link.download = `Snapshot_${Date.now()}.png`;
            link.href = editorCanvas.toDataURL();
            link.click();
            showToast("Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ kaydedildi!");
        };

        function updateTimelineVisuals() {
            const leftPct = (trimStartTime / videoDuration) * 100;
            const rightPct = ((videoDuration - trimEndTime) / videoDuration) * 100;
            
            document.getElementById('trim-visual-left').style.width = `${leftPct}%`;
            document.getElementById('trim-visual-right').style.width = `${rightPct}%`;
            // Active area calc handled by left/right styling automatically via css borders/position
        }

        function updateTimelineUI() {
            const pct = (editorVideo.currentTime / videoDuration) * 100;
            document.getElementById('scrubber-fill').style.width = `${pct}%`;
            document.getElementById('scrubber-thumb').style.left = `${pct}%`;
            document.getElementById('timeline-scrubber').value = pct;
            
            const m = Math.floor(editorVideo.currentTime/60).toString().padStart(2,'0');
            const s = Math.floor(editorVideo.currentTime%60).toString().padStart(2,'0');
            document.getElementById('editor-time').innerText = `${m}:${s}`;
        }

        // --- DRAWING LOOP ---
        function drawEditorFrame() {
            // 1. Draw Video
            editorCtx.drawImage(editorVideo, 0, 0, editorCanvas.width, editorCanvas.height);

            // 2. Draw Text Layers
            textLayers.forEach(layer => {
                editorCtx.font = `bold ${layer.size}px Arial`;
                editorCtx.fillStyle = layer.color;
                editorCtx.textAlign = "center";
                editorCtx.textBaseline = "middle";
                
                // Selection Border
                if (layer.id === selectedLayerId) {
                    const metrics = editorCtx.measureText(layer.text);
                    const h = layer.size;
                    const w = metrics.width;
                    const p = 10;
                    editorCtx.save();
                    editorCtx.strokeStyle = "#3b82f6";
                    editorCtx.lineWidth = 4;
                    editorCtx.setLineDash([10, 5]);
                    editorCtx.strokeRect(layer.x - w/2 - p, layer.y - h/2 - p, w + p*2, h + p*2);
                    editorCtx.restore();
                }

                editorCtx.fillText(layer.text, layer.x, layer.y);
            });

            if (isEditorPlaying) {
                animationFrameId = requestAnimationFrame(drawEditorFrame);
            }
        }

        // --- TEXT LAYERS & DRAGGING (UNCHANGED LOGIC) ---
        document.getElementById('add-text-btn').onclick = () => {
            const newLayer = {
                id: Date.now(),
                text: "Yeni Metin",
                x: editorCanvas.width / 2,
                y: editorCanvas.height / 2,
                color: "#ffffff",
                size: 60
            };
            textLayers.push(newLayer);
            selectLayer(newLayer.id);
            if(!isEditorPlaying) drawEditorFrame();
            updateLayersList();
        };

        function updateLayersList() {
            const list = document.getElementById('layers-list');
            const trackArea = document.getElementById('text-tracks-area');
            list.innerHTML = '';
            trackArea.innerHTML = '';
            textLayers.forEach(layer => {
                const item = document.createElement('div');
                item.className = `p-2 rounded bg-slate-950 border border-slate-700 cursor-pointer text-sm flex justify-between items-center layer-item ${layer.id === selectedLayerId ? 'active' : ''}`;
                item.innerHTML = `<span class="truncate w-32 font-medium">${layer.text}</span> <i class="fa-solid fa-pen text-slate-500 text-xs"></i>`;
                item.onclick = () => { selectLayer(layer.id); if(!isEditorPlaying) drawEditorFrame(); };
                list.appendChild(item);
                
                const track = document.createElement('div');
                track.className = "h-6 bg-blue-900/40 rounded border border-blue-800 relative overflow-hidden text-xs flex items-center px-2 text-blue-300 truncate";
                track.innerText = "T: " + layer.text;
                trackArea.appendChild(track);
            });
        }

        function selectLayer(id) {
            selectedLayerId = id;
            const layer = textLayers.find(l => l.id === id);
            if (layer) {
                document.getElementById('layer-props').classList.remove('hidden');
                document.getElementById('prop-text').value = layer.text;
                document.getElementById('prop-color').value = layer.color;
                document.getElementById('prop-size').value = layer.size;
            } else {
                document.getElementById('layer-props').classList.add('hidden');
            }
            updateLayersList();
        }

        // Property Listeners
        document.getElementById('prop-text').oninput = (e) => {
            const l = textLayers.find(l => l.id === selectedLayerId);
            if(l) { l.text = e.target.value; if(!isEditorPlaying) drawEditorFrame(); updateLayersList(); }
        };
        document.getElementById('prop-color').oninput = (e) => {
            const l = textLayers.find(l => l.id === selectedLayerId);
            if(l) { l.color = e.target.value; if(!isEditorPlaying) drawEditorFrame(); }
        };
        document.getElementById('prop-size').oninput = (e) => {
            const l = textLayers.find(l => l.id === selectedLayerId);
            if(l) { l.size = parseInt(e.target.value); if(!isEditorPlaying) drawEditorFrame(); }
        };
        document.getElementById('delete-layer-btn').onclick = () => {
            textLayers = textLayers.filter(l => l.id !== selectedLayerId);
            selectedLayerId = null;
            document.getElementById('layer-props').classList.add('hidden');
            if(!isEditorPlaying) drawEditorFrame();
            updateLayersList();
        };

        // Mouse Dragging
        function getMousePos(evt) {
            const rect = editorCanvas.getBoundingClientRect();
            const scaleX = editorCanvas.width / rect.width;
            const scaleY = editorCanvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }
        editorCanvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            for (let i = textLayers.length - 1; i >= 0; i--) {
                const layer = textLayers[i];
                const dist = Math.sqrt(Math.pow(pos.x - layer.x, 2) + Math.pow(pos.y - layer.y, 2));
                if (dist < layer.size * 2) { 
                    selectLayer(layer.id);
                    isDragging = true;
                    dragTargetId = layer.id;
                    if(!isEditorPlaying) drawEditorFrame();
                    return;
                }
            }
            selectedLayerId = null;
            document.getElementById('layer-props').classList.add('hidden');
            updateLayersList();
            if(!isEditorPlaying) drawEditorFrame();
        });
        editorCanvas.addEventListener('mousemove', (e) => {
            if (isDragging && dragTargetId) {
                const pos = getMousePos(e);
                const layer = textLayers.find(l => l.id === dragTargetId);
                if (layer) { layer.x = pos.x; layer.y = pos.y; if(!isEditorPlaying) drawEditorFrame(); }
            }
        });
        editorCanvas.addEventListener('mouseup', () => { isDragging = false; dragTargetId = null; });

        // ==========================================
        // PART 3: EXPORT / RENDER (UPDATED FOR TRIM)
        // ==========================================
        
        document.getElementById('export-btn').onclick = async () => {
            if(isEditorPlaying) togglePlay();
            
            renderOverlay.classList.remove('hidden');
            
            // Capture Canvas Stream
            const exportStream = editorCanvas.captureStream(60);
            
            // Audio workaround
            const acExport = new AudioContext();
            const sourceNode = acExport.createMediaElementSource(editorVideo);
            const destNode = acExport.createMediaStreamDestination();
            sourceNode.connect(destNode);
            sourceNode.connect(acExport.destination); 

            if (destNode.stream.getAudioTracks().length > 0) {
                exportStream.addTrack(destNode.stream.getAudioTracks()[0]);
            }
            
            const recorder = new MediaRecorder(exportStream, { mimeType: 'video/webm;codecs=vp9' });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                acExport.close();
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RecMaster_Edited_${Date.now()}.webm`;
                a.click();
                
                renderOverlay.classList.add('hidden');
                showToast("Video indiriliyor...");
                
                // Reset playback settings
                editorVideo.currentTime = trimStartTime;
                editorVideo.playbackRate = 1.0;
            };

            recorder.start();

            // RENDER LOGIC: Seek to Trim Start, Play until Trim End
            editorVideo.currentTime = trimStartTime;
            editorVideo.playbackRate = playbackSpeed; // Render at selected speed
            
            await editorVideo.play();
            
            const updateRenderLoop = () => {
                drawEditorFrame();
                
                // Progress within trimmed area
                const duration = trimEndTime - trimStartTime;
                const current = editorVideo.currentTime - trimStartTime;
                let pct = (current / duration) * 100;
                if(pct > 100) pct = 100;
                if(pct < 0) pct = 0;

                document.getElementById('render-progress').style.width = `${pct}%`;
                document.getElementById('render-status').innerText = Math.round(pct) + "%";

                // Stop if we reach trimEndTime
                if (!editorVideo.paused && !editorVideo.ended && editorVideo.currentTime < trimEndTime) {
                    requestAnimationFrame(updateRenderLoop);
                } else {
                    recorder.stop();
                    editorVideo.pause();
                }
            };
            
            updateRenderLoop();
        };

        document.getElementById('new-record-btn').onclick = () => location.reload();

    </script>
</body>
</html>
