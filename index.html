<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecMaster Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .recording-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .timeline-ruler {
            background-image: linear-gradient(90deg, #475569 1px, transparent 1px);
            background-size: 100px 100%;
            background-repeat: repeat-x;
        }
        .timeline-sub-ruler {
            background-image: linear-gradient(90deg, #334155 1px, transparent 1px);
            background-size: 10px 100%;
            background-repeat: repeat-x;
        }

        /* Scrubber */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 100vh; /* Full height visual guide */
            width: 1px;
            background: #ef4444;
            margin-top: 0;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
            cursor: ew-resize;
            position: relative;
            z-index: 50;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 24px;
            cursor: pointer;
            background: transparent;
        }

        .layer-block {
            transition: all 0.1s;
        }
        .layer-block:hover {
            filter: brightness(1.1);
        }
        .layer-block.selected {
            border: 1px solid #60a5fa;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden select-none">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 h-12 flex items-center px-4 justify-between shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 bg-gradient-to-br from-indigo-600 to-violet-600 rounded flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-layer-group text-white text-xs"></i>
            </div>
            <h1 class="font-bold text-sm tracking-wide text-slate-100">RecMaster <span class="text-indigo-400 font-normal">Studio Pro</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="mode-display" class="text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700 text-slate-400">Bekleniyor</div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Toast & Overlays -->
        <div id="toast" class="hidden absolute top-4 right-4 bg-indigo-600 text-white px-4 py-3 rounded shadow-lg z-[60] flex items-center animate-fade-in text-sm font-medium">
            <i class="fa-solid fa-circle-info mr-2"></i> <span id="toast-msg">Mesaj</span>
        </div>
        
        <div id="countdown-overlay" class="hidden absolute inset-0 bg-slate-950/95 z-[70] flex items-center justify-center">
            <div class="text-9xl font-bold text-white animate-ping" id="countdown-text">3</div>
        </div>

        <div id="render-overlay" class="hidden absolute inset-0 bg-slate-950/95 z-[70] flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 class="text-xl font-bold text-white mb-1">Video Oluşturuluyor</h2>
            <p class="text-slate-400 text-sm mb-4">Efektler işleniyor, lütfen bekleyin...</p>
            <div class="w-64 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                <div id="render-progress" class="h-full bg-indigo-500 w-0 transition-all duration-100"></div>
            </div>
            <p id="render-status" class="text-xs text-slate-500 mt-2">0%</p>
        </div>

        <!-- VIEW 1: Recorder Setup (Center Stage) -->
        <div id="setup-panel" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950 z-40">
            <div class="w-full max-w-2xl bg-slate-900/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-800/60 shadow-2xl text-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-tr from-indigo-500/5 via-transparent to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                
                <h2 class="text-2xl font-bold text-white mb-2 relative">Yeni Proje Oluştur</h2>
                <p class="text-slate-400 text-sm mb-8 relative">Ekran kaydı alarak düzenlemeye başlayın.</p>

                <div class="grid grid-cols-2 gap-4 mb-8 relative">
                    <label class="cursor-pointer bg-slate-800 hover:bg-slate-750 hover:border-indigo-500/30 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center gap-3 transition-all group/item">
                        <div class="w-10 h-10 rounded-full bg-slate-700 group-hover/item:bg-indigo-500/20 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-microphone text-indigo-400"></i>
                        </div>
                        <span class="text-sm font-medium">Mikrofon</span>
                        <input type="checkbox" id="mic-toggle" class="accent-indigo-500">
                    </label>

                    <label class="cursor-pointer bg-slate-800 hover:bg-slate-750 hover:border-purple-500/30 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center gap-3 transition-all group/item">
                        <div class="w-10 h-10 rounded-full bg-slate-700 group-hover/item:bg-purple-500/20 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-camera text-purple-400"></i>
                        </div>
                        <span class="text-sm font-medium">Yüz Kamerası</span>
                        <input type="checkbox" id="cam-toggle" class="accent-purple-500">
                    </label>
                </div>

                <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 rounded-lg shadow-lg shadow-indigo-900/20 flex items-center justify-center gap-2 transition-transform active:scale-[0.98] relative">
                    <i class="fa-solid fa-circle text-[10px] animate-pulse"></i> Kaydı Başlat
                </button>
            </div>
        </div>

        <!-- Recording Status Bar (Floating) -->
        <div id="recording-status" class="hidden absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-slate-700 pr-2 pl-6 py-2 rounded-full flex items-center gap-6 shadow-2xl z-[80]">
            <div class="flex items-center gap-3">
                <div class="w-2.5 h-2.5 bg-red-500 rounded-full recording-pulse"></div>
                <span class="font-mono text-lg w-20 tracking-wider" id="timer">00:00</span>
            </div>
            <div class="h-6 w-px bg-slate-700"></div>
            <button id="stop-btn-top" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg transition-colors">
                <i class="fa-solid fa-stop text-xs"></i>
            </button>
        </div>

        <!-- VIEW 2: Editor Interface (Hidden by default) -->
        <div id="editor-ui" class="hidden absolute inset-0 flex flex-col z-30 bg-slate-950">
            
            <!-- Top Section: Tools, Preview, Properties -->
            <div class="flex-1 flex overflow-hidden border-b border-slate-800">
                
                <!-- Left Sidebar: Tools -->
                <div class="w-14 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-4 gap-4 shrink-0">
                    <button class="w-9 h-9 rounded hover:bg-slate-800 text-slate-400 hover:text-indigo-400 flex items-center justify-center transition-colors tooltip-trigger" title="Seçim Aracı">
                        <i class="fa-solid fa-arrow-pointer"></i>
                    </button>
                    <button id="add-text-btn" class="w-9 h-9 rounded hover:bg-slate-800 text-slate-400 hover:text-indigo-400 flex items-center justify-center transition-colors tooltip-trigger" title="Yazı Ekle">
                        <i class="fa-solid fa-t"></i>
                    </button>
                    <button id="snapshot-btn" class="w-9 h-9 rounded hover:bg-slate-800 text-slate-400 hover:text-indigo-400 flex items-center justify-center transition-colors tooltip-trigger" title="Anlık Görüntü">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                    <div class="w-6 h-px bg-slate-800 my-1"></div>
                    <button id="split-layer-btn" class="w-9 h-9 rounded hover:bg-slate-800 text-slate-400 hover:text-red-400 flex items-center justify-center transition-colors tooltip-trigger" title="Katmanı Böl (Split)">
                        <i class="fa-solid fa-scissors"></i>
                    </button>
                </div>

                <!-- Center: Viewport -->
                <div class="flex-1 bg-black/50 flex flex-col relative overflow-hidden">
                    <div class="flex-1 flex items-center justify-center p-8 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiMzMzMiLz48L3N2Zz4=')]">
                        <canvas id="editor-canvas" class="max-w-full max-h-full shadow-2xl ring-1 ring-slate-800"></canvas>
                    </div>
                    
                    <!-- Transport Controls -->
                    <div class="h-12 bg-slate-900 border-t border-slate-800 flex items-center justify-center gap-6">
                        <span id="editor-time-current" class="font-mono text-xs text-slate-400 w-16 text-right">00:00:00</span>
                        
                        <div class="flex items-center gap-2">
                             <button id="btn-seek-start" class="text-slate-400 hover:text-white p-2"><i class="fa-solid fa-backward-step"></i></button>
                            <button id="editor-play-btn" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-white text-slate-900 flex items-center justify-center transition-transform hover:scale-105">
                                <i class="fa-solid fa-play text-xs ml-0.5"></i>
                            </button>
                            <button id="btn-seek-end" class="text-slate-400 hover:text-white p-2"><i class="fa-solid fa-forward-step"></i></button>
                        </div>
                        
                        <span id="editor-time-total" class="font-mono text-xs text-slate-500 w-16 text-left">00:00:00</span>
                    </div>
                </div>

                <!-- Right Sidebar: Properties -->
                <div class="w-64 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0">
                    <div class="h-10 border-b border-slate-800 flex items-center px-4 font-bold text-xs uppercase tracking-wider text-slate-500">
                        Özellikler
                    </div>
                    
                    <!-- Layer Properties (Conditional) -->
                    <div id="layer-props" class="p-4 space-y-4 hidden">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1.5">Metin İçeriği</label>
                            <textarea id="prop-text" rows="2" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-white focus:border-indigo-500 focus:outline-none resize-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-400 block mb-1.5">Renk</label>
                                <div class="flex items-center gap-2 bg-slate-950 border border-slate-700 rounded-lg p-1">
                                    <input type="color" id="prop-color" class="w-6 h-6 rounded cursor-pointer bg-transparent border-none p-0">
                                    <span class="text-xs text-slate-500 font-mono">HEX</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 block mb-1.5">Boyut</label>
                                <input type="number" id="prop-size" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-1.5 text-sm text-white focus:border-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="pt-4 border-t border-slate-800">
                            <button id="delete-layer-btn" class="w-full py-2 rounded border border-red-500/20 text-red-400 hover:bg-red-500/10 text-xs transition-colors">
                                <i class="fa-solid fa-trash mr-2"></i> Sil
                            </button>
                        </div>
                    </div>
                    
                    <!-- Global Settings (When no layer selected) -->
                    <div id="global-props" class="p-4 space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1.5">Video Hızı</label>
                            <select id="speed-select" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-white focus:border-indigo-500 outline-none">
                                <option value="0.5">0.5x (Yavaş)</option>
                                <option value="1.0" selected>1.0x (Normal)</option>
                                <option value="1.5">1.5x (Hızlı)</option>
                                <option value="2.0">2.0x (Çok Hızlı)</option>
                            </select>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3 text-xs text-slate-400 border border-slate-800">
                            <i class="fa-solid fa-circle-info mr-1 text-indigo-400"></i>
                            Videoyu kesmek için alttaki zaman çizelgesinde "Giriş" ve "Çıkış" noktalarını ayarlayın.
                        </div>
                        <button id="export-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 mt-4 transition-all">
                            <i class="fa-solid fa-download"></i> Dışa Aktar
                        </button>
                        <button id="new-record-btn" class="w-full text-slate-500 hover:text-slate-300 text-xs py-2">
                            Projeyi Kapat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom: Timeline -->
            <div class="h-64 bg-slate-900 border-t border-slate-800 flex flex-col shrink-0">
                
                <!-- Toolbar for Timeline -->
                <div class="h-10 border-b border-slate-800 flex items-center justify-between px-2 bg-slate-850">
                    <div class="flex items-center gap-1">
                        <button id="set-in-btn" class="h-7 px-3 rounded hover:bg-slate-700 text-xs font-medium text-slate-300 border border-transparent hover:border-slate-600">
                            <i class="fa-solid fa-bracket-left mr-1 text-indigo-400"></i> Giriş (In)
                        </button>
                        <button id="set-out-btn" class="h-7 px-3 rounded hover:bg-slate-700 text-xs font-medium text-slate-300 border border-transparent hover:border-slate-600">
                            Çıkış (Out) <i class="fa-solid fa-bracket-right ml-1 text-indigo-400"></i>
                        </button>
                        <div class="w-px h-4 bg-slate-700 mx-2"></div>
                        <button id="reset-trim-btn" class="h-7 px-2 rounded hover:bg-slate-700 text-xs text-slate-400" title="Kesimi Sıfırla">
                            <i class="fa-solid fa-rotate-left"></i>
                        </button>
                    </div>
                    <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mr-2">Timeline</div>
                </div>

                <!-- Timeline Tracks Area -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden relative custom-scrollbar bg-slate-950" id="timeline-container">
                    
                    <!-- Time Ruler -->
                    <div class="h-6 w-full sticky top-0 z-20 bg-slate-900 border-b border-slate-800 relative">
                        <div class="absolute inset-0 timeline-ruler opacity-20"></div>
                        <div class="absolute inset-0 timeline-sub-ruler opacity-10"></div>
                        
                        <!-- Range Scrubber Input (Invisible but interactive) -->
                        <input type="range" id="timeline-scrubber" min="0" max="100" value="0" step="0.01" class="absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-30">
                        
                        <!-- Playhead (Visual) -->
                        <div id="playhead" class="absolute top-0 bottom-0 w-px bg-red-500 h-[1000px] pointer-events-none z-10 translate-x-0 transition-transform duration-75 ease-linear flex flex-col items-center">
                            <div class="w-3 h-3 -mt-1.5 bg-red-500 rotate-45 transform shadow-sm"></div>
                        </div>

                         <!-- Trim Indicators (Visual Overlay on top of tracks) -->
                        <div id="trim-overlay-left" class="absolute top-6 bottom-0 left-0 bg-black/60 border-r border-indigo-500/50 z-20 pointer-events-none w-0 backdrop-grayscale"></div>
                        <div id="trim-overlay-right" class="absolute top-6 bottom-0 right-0 bg-black/60 border-l border-indigo-500/50 z-20 pointer-events-none w-0 backdrop-grayscale"></div>
                    </div>

                    <!-- Tracks Content -->
                    <div class="p-2 space-y-1 relative min-h-[200px]">
                        
                        <!-- Video Track -->
                        <div class="h-10 bg-slate-900 rounded border border-slate-800 flex overflow-hidden relative group">
                            <div class="w-24 shrink-0 bg-slate-850 border-r border-slate-800 flex items-center px-3 text-xs font-medium text-indigo-400 select-none z-10">
                                <i class="fa-solid fa-video mr-2 opacity-50"></i> V1
                            </div>
                            <div class="flex-1 relative overflow-hidden bg-slate-900">
                                <!-- Thumbnails placeholder pattern -->
                                <div class="absolute inset-0 flex opacity-20">
                                    <div class="flex-1 border-r border-slate-700/50 bg-[linear-gradient(45deg,transparent_45%,#fff_50%,transparent_55%)] bg-[length:10px_10px]"></div>
                                    <div class="flex-1 border-r border-slate-700/50"></div>
                                    <div class="flex-1 border-r border-slate-700/50"></div>
                                    <div class="flex-1 border-r border-slate-700/50"></div>
                                    <div class="flex-1 border-r border-slate-700/50"></div>
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-600 font-mono tracking-widest uppercase">
                                    Ana Kayıt (Video)
                                </div>
                            </div>
                        </div>

                        <!-- Audio Track -->
                        <div class="h-8 bg-slate-900 rounded border border-slate-800 flex overflow-hidden relative opacity-80">
                            <div class="w-24 shrink-0 bg-slate-850 border-r border-slate-800 flex items-center px-3 text-xs font-medium text-emerald-400 select-none z-10">
                                <i class="fa-solid fa-volume-high mr-2 opacity-50"></i> A1
                            </div>
                            <div class="flex-1 relative overflow-hidden bg-emerald-900/10">
                                <div class="absolute inset-0 opacity-30 flex items-center">
                                    <div class="w-full h-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjEwIj48cmVjdCB3aWR0aD0iMiIgaGVpZ2h0PSI2IiB4PSIxIiB5PSIyIiBmaWxsPSIjMzRkMzk5IiAvPjwvc3ZnPg==')]"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Text Tracks Area -->
                        <div id="text-tracks-container" class="space-y-1 pt-1"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Hidden Video Elements -->
    <video id="src-video-screen" autoplay muted class="hidden"></video>
    <video id="src-video-cam" autoplay muted class="hidden"></video>
    <video id="editor-source-video" class="hidden" playsinline></video>
    <canvas id="compositor-canvas" class="hidden"></canvas>

    <script>
        /**
         * RecMaster Studio Pro Logic
         */
        
        // --- State ---
        let state = {
            mode: 'setup', // setup, recording, editing
            isRecording: false,
            isPlaying: false,
            duration: 0,
            currentTime: 0,
            trimStart: 0,
            trimEnd: 0,
            playbackSpeed: 1.0,
            selectedLayerId: null
        };

        let mediaRecorder;
        let recordedChunks = [];
        let streams = { display: null, user: null };
        let textLayers = []; // { id, text, x, y, size, color, startPct, endPct }
        let timerInt;
        let animFrame;

        // --- Elements ---
        const els = {
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn-top'),
            setupPanel: document.getElementById('setup-panel'),
            recordingStatus: document.getElementById('recording-status'),
            editorUi: document.getElementById('editor-ui'),
            video: document.getElementById('editor-source-video'),
            canvas: document.getElementById('editor-canvas'),
            ctx: document.getElementById('editor-canvas').getContext('2d'),
            scrubber: document.getElementById('timeline-scrubber'),
            playhead: document.getElementById('playhead'),
            timeCurrent: document.getElementById('editor-time-current'),
            timeTotal: document.getElementById('editor-time-total'),
            timer: document.getElementById('timer'),
            countdown: document.getElementById('countdown-overlay'),
            renderOverlay: document.getElementById('render-overlay'),
            toast: document.getElementById('toast'),
            trimLeft: document.getElementById('trim-overlay-left'),
            trimRight: document.getElementById('trim-overlay-right'),
            textTracks: document.getElementById('text-tracks-container'),
            layerProps: document.getElementById('layer-props'),
            globalProps: document.getElementById('global-props'),
            btnPlay: document.getElementById('editor-play-btn'),
            btnSeekStart: document.getElementById('btn-seek-start'),
            btnSeekEnd: document.getElementById('btn-seek-end')
        };

        // --- Utils ---
        const fmtTime = s => {
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = Math.floor(s % 60).toString().padStart(2, '0');
            const ms = Math.floor((s % 1) * 100).toString().padStart(2, '0');
            return `${m}:${sec}:${ms}`;
        };

        const toast = (msg) => {
            document.getElementById('toast-msg').innerText = msg;
            els.toast.classList.remove('hidden');
            setTimeout(() => els.toast.classList.add('hidden'), 3000);
        };

        // --- Recording Phase ---
        els.startBtn.onclick = async () => {
            const mic = document.getElementById('mic-toggle').checked;
            const cam = document.getElementById('cam-toggle').checked;

            try {
                streams.display = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 60 }, audio: true });
                
                if (mic || cam) {
                    try {
                        streams.user = await navigator.mediaDevices.getUserMedia({ 
                            audio: mic, 
                            video: cam ? { width: 320, height: 240 } : false 
                        });
                    } catch(e) { toast('Kamera/Mikrofon izni alınamadı.'); }
                }

                // Countdown
                els.setupPanel.classList.add('hidden');
                els.countdown.classList.remove('hidden');
                let c = 3;
                let cInt = setInterval(() => {
                    c--;
                    document.getElementById('countdown-text').innerText = c;
                    if(c<=0) {
                        clearInterval(cInt);
                        els.countdown.classList.add('hidden');
                        startRecording(cam);
                    }
                }, 1000);

            } catch (e) { console.error(e); }
        };

        async function startRecording(useCam) {
            state.isRecording = true;
            document.getElementById('mode-display').innerText = "KAYITTA";
            document.getElementById('mode-display').className = "text-xs px-2 py-0.5 rounded bg-red-900/30 border border-red-800 text-red-400 animate-pulse";
            els.recordingStatus.classList.remove('hidden');

            const compCanvas = document.getElementById('compositor-canvas');
            const compCtx = compCanvas.getContext('2d');
            const vScreen = document.getElementById('src-video-screen');
            const vCam = document.getElementById('src-video-cam');

            vScreen.srcObject = streams.display;
            await vScreen.play();
            compCanvas.width = vScreen.videoWidth;
            compCanvas.height = vScreen.videoHeight;

            // Audio Mixing
            const ac = new AudioContext();
            const dest = ac.createMediaStreamDestination();
            if(streams.display.getAudioTracks().length) ac.createMediaStreamSource(streams.display).connect(dest);
            if(streams.user && streams.user.getAudioTracks().length) {
                const ms = ac.createMediaStreamSource(streams.user);
                ms.connect(ac.createGain()).connect(dest);
            }

            // Draw Loop
            if(useCam && streams.user && streams.user.getVideoTracks().length) {
                vCam.srcObject = streams.user;
                await vCam.play();
                function draw() {
                    if(!state.isRecording) return;
                    compCtx.drawImage(vScreen, 0, 0);
                    // PIP
                    const s = compCanvas.height * 0.25;
                    const m = 40;
                    const x = compCanvas.width - s - m;
                    const y = compCanvas.height - s - m;
                    compCtx.save();
                    compCtx.beginPath();
                    compCtx.arc(x+s/2, y+s/2, s/2, 0, Math.PI*2);
                    compCtx.clip();
                    compCtx.drawImage(vCam, x, y, s, s);
                    compCtx.lineWidth = 6; compCtx.strokeStyle = "#fff"; compCtx.stroke();
                    compCtx.restore();
                    requestAnimationFrame(draw);
                }
                draw();
            } else {
                // Simple pass through if no cam, but using canvas for consistency
                 function drawSimple() {
                    if(!state.isRecording) return;
                    compCtx.drawImage(vScreen, 0, 0);
                    requestAnimationFrame(drawSimple);
                }
                drawSimple();
            }

            const stream = compCanvas.captureStream(60);
            if(dest.stream.getAudioTracks().length) stream.addTrack(dest.stream.getAudioTracks()[0]);

            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            recordedChunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = stopRecording;
            
            // Native stop
            streams.display.getVideoTracks()[0].onended = () => mediaRecorder.stop();

            mediaRecorder.start();
            
            let secs = 0;
            timerInt = setInterval(() => {
                secs++;
                const m = Math.floor(secs/60).toString().padStart(2,'0');
                const s = (secs%60).toString().padStart(2,'0');
                els.timer.innerText = `${m}:${s}`;
            }, 1000);
        }

        els.stopBtn.onclick = () => mediaRecorder.stop();

        function stopRecording() {
            state.isRecording = false;
            clearInterval(timerInt);
            streams.display.getTracks().forEach(t=>t.stop());
            if(streams.user) streams.user.getTracks().forEach(t=>t.stop());
            
            els.recordingStatus.classList.add('hidden');
            initEditor();
        }

        // --- Editing Phase ---
        function initEditor() {
            els.editorUi.classList.remove('hidden');
            document.getElementById('mode-display').innerText = "DÜZENLEME";
            document.getElementById('mode-display').className = "text-xs px-2 py-0.5 rounded bg-indigo-900/30 border border-indigo-800 text-indigo-400";

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            els.video.src = url;
            
            els.video.onloadedmetadata = () => {
                state.duration = els.video.duration;
                state.trimEnd = state.duration;
                els.timeTotal.innerText = fmtTime(state.duration);
                els.canvas.width = els.video.videoWidth;
                els.canvas.height = els.video.videoHeight;
                renderFrame();
            };
        }

        // --- Timeline Logic ---
        els.scrubber.addEventListener('input', (e) => {
            const pct = parseFloat(e.target.value);
            const t = (pct / 100) * state.duration;
            els.video.currentTime = t;
            state.currentTime = t;
            updateUI();
            if(!state.isPlaying) renderFrame();
        });

        // Split Logic
        document.getElementById('split-layer-btn').onclick = () => {
            if(!state.selectedLayerId) {
                toast("Lütfen önce bir yazı katmanı seçin.");
                return;
            }
            // Find layer
            const layerIndex = textLayers.findIndex(l => l.id === state.selectedLayerId);
            if(layerIndex === -1) return;

            const layer = textLayers[layerIndex];
            const currentPct = (state.currentTime / state.duration) * 100;

            // Check boundaries
            if(currentPct <= layer.startPct || currentPct >= layer.endPct) {
                toast("Oynatma çubuğu katmanın üzerinde değil.");
                return;
            }

            // Clone and adjust
            const newLayer = { ...layer, id: Date.now(), startPct: currentPct };
            layer.endPct = currentPct; // Cut first one
            
            textLayers.push(newLayer);
            renderTimelineTracks();
            toast("Katman bölündü.");
            renderFrame();
        };

        function updateUI() {
            // Update Scrubber Position
            const pct = (state.currentTime / state.duration) * 100;
            els.scrubber.value = pct;
            els.playhead.style.left = `${pct}%`;
            els.timeCurrent.innerText = fmtTime(state.currentTime);

            // Loop trim
            if(state.isPlaying && state.currentTime >= state.trimEnd) {
                els.video.currentTime = state.trimStart;
            }
        }

        // --- Editor Render Loop ---
        function renderFrame() {
            // Draw Video
            els.ctx.drawImage(els.video, 0, 0, els.canvas.width, els.canvas.height);

            // Draw Layers
            const pct = (state.currentTime / state.duration) * 100;
            
            textLayers.forEach(l => {
                if(pct >= l.startPct && pct <= l.endPct) {
                    els.ctx.save();
                    els.ctx.font = `bold ${l.size}px Arial`;
                    els.ctx.fillStyle = l.color;
                    els.ctx.textAlign = "center";
                    els.ctx.textBaseline = "middle";
                    
                    // Selection Box
                    if(l.id === state.selectedLayerId) {
                        const m = els.ctx.measureText(l.text);
                        const w = m.width + 20;
                        const h = l.size + 20;
                        els.ctx.strokeStyle = "#60a5fa";
                        els.ctx.lineWidth = 4;
                        els.ctx.setLineDash([6, 4]);
                        els.ctx.strokeRect(l.x - w/2, l.y - h/2, w, h);
                        
                        // Handles (Visual only)
                        els.ctx.fillStyle = "#60a5fa";
                        els.ctx.fillRect(l.x - w/2 - 5, l.y - h/2 - 5, 10, 10);
                        els.ctx.fillRect(l.x + w/2 - 5, l.y + h/2 - 5, 10, 10);
                        // Revert fill
                        els.ctx.fillStyle = l.color;
                    }

                    els.ctx.shadowColor = "rgba(0,0,0,0.5)";
                    els.ctx.shadowBlur = 4;
                    els.ctx.fillText(l.text, l.x, l.y);
                    els.ctx.restore();
                }
            });

            if(state.isPlaying) requestAnimationFrame(renderFrame);
        }

        // --- Controls ---
        els.btnPlay.onclick = () => {
            if(state.isPlaying) {
                els.video.pause();
                state.isPlaying = false;
                els.btnPlay.innerHTML = '<i class="fa-solid fa-play text-xs ml-0.5"></i>';
            } else {
                if(state.currentTime >= state.trimEnd) els.video.currentTime = state.trimStart;
                els.video.playbackRate = state.playbackSpeed;
                els.video.play();
                state.isPlaying = true;
                els.btnPlay.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                renderFrame();
            }
        };

        els.video.addEventListener('timeupdate', () => {
            state.currentTime = els.video.currentTime;
            updateUI();
        });

        // Trim
        document.getElementById('set-in-btn').onclick = () => {
            state.trimStart = state.currentTime;
            updateTrimUI();
        };
        document.getElementById('set-out-btn').onclick = () => {
            state.trimEnd = state.currentTime;
            updateTrimUI();
        };
        document.getElementById('reset-trim-btn').onclick = () => {
            state.trimStart = 0;
            state.trimEnd = state.duration;
            updateTrimUI();
        };

        function updateTrimUI() {
            const l = (state.trimStart / state.duration) * 100;
            const r = ((state.duration - state.trimEnd) / state.duration) * 100;
            els.trimLeft.style.width = `${l}%`;
            els.trimRight.style.width = `${r}%`;
        }

        // --- Layers Logic ---
        document.getElementById('add-text-btn').onclick = () => {
            const id = Date.now();
            textLayers.push({
                id: id,
                text: 'Yeni Metin',
                x: els.canvas.width / 2,
                y: els.canvas.height / 2,
                size: 60,
                color: '#ffffff',
                startPct: 0,
                endPct: 100
            });
            selectLayer(id);
            renderTimelineTracks();
            renderFrame();
        };

        function selectLayer(id) {
            state.selectedLayerId = id;
            if(id) {
                const l = textLayers.find(x => x.id === id);
                els.layerProps.classList.remove('hidden');
                els.globalProps.classList.add('hidden');
                document.getElementById('prop-text').value = l.text;
                document.getElementById('prop-color').value = l.color;
                document.getElementById('prop-size').value = l.size;
            } else {
                els.layerProps.classList.add('hidden');
                els.globalProps.classList.remove('hidden');
            }
            renderTimelineTracks(); // Update selection highlight
            renderFrame();
        }

        function renderTimelineTracks() {
            els.textTracks.innerHTML = '';
            textLayers.forEach(l => {
                const div = document.createElement('div');
                div.className = `h-6 rounded text-[10px] flex items-center px-2 cursor-pointer relative overflow-hidden layer-block ${l.id === state.selectedLayerId ? 'bg-indigo-600 text-white selected' : 'bg-slate-800 text-slate-300 border border-slate-700'}`;
                
                // Position logic based on pct
                div.style.marginLeft = `${l.startPct}%`;
                div.style.width = `${l.endPct - l.startPct}%`;
                div.innerText = l.text;
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    selectLayer(l.id);
                };

                els.textTracks.appendChild(div);
            });
        }

        // Layer Properties Inputs
        document.getElementById('prop-text').oninput = (e) => {
            const l = textLayers.find(x => x.id === state.selectedLayerId);
            if(l) { l.text = e.target.value; renderFrame(); renderTimelineTracks(); }
        };
        document.getElementById('prop-color').oninput = (e) => {
            const l = textLayers.find(x => x.id === state.selectedLayerId);
            if(l) { l.color = e.target.value; renderFrame(); }
        };
        document.getElementById('prop-size').oninput = (e) => {
            const l = textLayers.find(x => x.id === state.selectedLayerId);
            if(l) { l.size = parseInt(e.target.value); renderFrame(); }
        };
        document.getElementById('delete-layer-btn').onclick = () => {
            textLayers = textLayers.filter(x => x.id !== state.selectedLayerId);
            selectLayer(null);
        };

        // Canvas Interaction (Drag)
        let isDragging = false;
        els.canvas.addEventListener('mousedown', (e) => {
            const rect = els.canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (els.canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (els.canvas.height / rect.height);
            
            // Hit test
            for(let i=textLayers.length-1; i>=0; i--) {
                const l = textLayers[i];
                // Simple box hit test
                const d = Math.sqrt((x-l.x)**2 + (y-l.y)**2);
                if(d < l.size) { // Approx hit
                    selectLayer(l.id);
                    isDragging = true;
                    return;
                }
            }
            selectLayer(null);
        });

        els.canvas.addEventListener('mousemove', (e) => {
            if(isDragging && state.selectedLayerId) {
                const rect = els.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (els.canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (els.canvas.height / rect.height);
                const l = textLayers.find(x => x.id === state.selectedLayerId);
                l.x = x; l.y = y;
                renderFrame();
            }
        });

        els.canvas.addEventListener('mouseup', () => isDragging = false);

        // --- Export ---
        document.getElementById('export-btn').onclick = async () => {
            if(state.isPlaying) els.btnPlay.click();
            
            els.renderOverlay.classList.remove('hidden');
            
            // Setup recorder
            const stream = els.canvas.captureStream(60);
            
            // Audio from video element (needs workaround to capture while seeking)
            const ac = new AudioContext();
            const source = ac.createMediaElementSource(els.video);
            const dest = ac.createMediaStreamDestination();
            source.connect(dest);
            source.connect(ac.destination); // Mute locally?
            
            if(dest.stream.getAudioTracks().length) stream.addTrack(dest.stream.getAudioTracks()[0]);

            const rec = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            const chunks = [];
            rec.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            
            rec.onstop = () => {
                const b = new Blob(chunks, { type: 'video/webm' });
                const u = URL.createObjectURL(b);
                const a = document.createElement('a');
                a.href = u;
                a.download = `RecMaster_Pro_Export.webm`;
                a.click();
                els.renderOverlay.classList.add('hidden');
                toast("İndirme başladı.");
            };

            rec.start();

            // Playback for render
            els.video.currentTime = state.trimStart;
            await els.video.play();
            
            const renderLoop = () => {
                renderFrame();
                const p = ((els.video.currentTime - state.trimStart) / (state.trimEnd - state.trimStart)) * 100;
                document.getElementById('render-progress').style.width = `${p}%`;
                document.getElementById('render-status').innerText = Math.round(p) + '%';
                
                if(els.video.currentTime < state.trimEnd && !els.video.ended) {
                    requestAnimationFrame(renderLoop);
                } else {
                    rec.stop();
                    els.video.pause();
                }
            };
            renderLoop();
        };

        // Snapshot
        document.getElementById('snapshot-btn').onclick = () => {
            const a = document.createElement('a');
            a.download = 'snapshot.png';
            a.href = els.canvas.toDataURL();
            a.click();
            toast("Anlık görüntü alındı");
        };

        document.getElementById('new-record-btn').onclick = () => location.reload();

    </script>
</body>
</html>
