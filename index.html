<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecMaster: Modern Ekran Kaydedici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .recording-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Crop Box */
        #crop-container {
            user-select: none;
            touch-action: none;
            overflow: hidden;
        }
        #crop-box {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); 
            cursor: move;
            z-index: 20;
            outline: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }
        #crop-box.recording-mode {
            box-shadow: none;
            cursor: default;
            pointer-events: none;
            background: transparent;
            outline: 3px solid rgba(239, 68, 68, 0.8); 
            outline-offset: 2px;
            animation: guide-pulse 2s infinite;
            border-radius: 0;
        }
        
        @keyframes guide-pulse {
            0% { outline-color: rgba(239, 68, 68, 1); }
            50% { outline-color: rgba(239, 68, 68, 0.3); }
            100% { outline-color: rgba(239, 68, 68, 1); }
        }

        .resize-handle {
            width: 10px;
            height: 10px;
            background-color: white;
            border: 2px solid #ef4444;
            position: absolute;
            border-radius: 50%;
            z-index: 30;
            transition: transform 0.1s;
        }
        .resize-handle:hover { transform: scale(1.5); }
        .handle-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .handle-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .handle-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .handle-se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Segmented Control */
        .segmented-control {
            background: rgba(2, 6, 23, 0.5);
            padding: 4px;
            border-radius: 10px;
            display: inline-flex;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .segment-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .segment-btn:hover { color: #cbd5e1; }
        .segment-btn.active {
            background: #1e293b;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Audio Visualizer Bar */
        .audio-meter {
            width: 4px;
            background-color: #334155;
            border-radius: 2px;
            transition: height 0.05s ease;
            height: 4px;
        }
        .audio-meter.active {
            background-color: #4ade80;
            box-shadow: 0 0 4px #4ade80;
        }

        /* Cam Position Grid */
        .cam-pos-btn {
            background-color: #334155;
            border-radius: 2px;
            width: 100%;
            height: 100%;
            border: 1px solid transparent;
        }
        .cam-pos-btn:hover { background-color: #475569; }
        .cam-pos-btn.active { background-color: #f8fafc; border-color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden select-none bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center">
    
    <!-- Backdrop Overlay -->
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm z-0"></div>

    <!-- Header -->
    <header class="h-16 flex items-center px-6 justify-between shrink-0 z-50 relative border-b border-white/5 bg-slate-950/50 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center border border-white/10">
                <i class="fa-solid fa-record-vinyl text-red-500"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white">RecMaster</h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="status-badge" class="text-[10px] uppercase tracking-wider px-2 py-1 rounded border border-slate-700 text-slate-400 font-bold">Hazır</div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden relative items-center justify-center p-6 z-10">
        
        <!-- Toast Notification -->
        <div id="toast" class="hidden absolute top-6 right-6 bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-lg shadow-2xl z-[90] flex items-center animate-fade-in text-sm font-medium">
            <i class="fa-solid fa-circle-info text-blue-400 mr-3"></i> <span id="toast-msg">Mesaj</span>
        </div>
        
        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="hidden absolute inset-0 bg-black/80 backdrop-blur-md z-[80] flex items-center justify-center">
            <div class="text-9xl font-black text-white animate-pulse" id="countdown-text" style="font-variant-numeric: tabular-nums;">3</div>
        </div>

        <!-- Crop/Area Selection Overlay (Preview Mode) -->
        <div id="crop-overlay" class="hidden absolute inset-0 bg-slate-950 z-[60] flex flex-col animate-fade-in">
            <!-- Toolbar -->
            <div class="h-16 border-b border-white/5 bg-slate-900/80 flex items-center justify-between px-6 shrink-0 z-50 backdrop-blur-md">
                
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-slate-400 mr-2 hidden md:inline">Kayıt Alanı:</span>
                    <div class="segmented-control">
                        <button type="button" class="segment-btn active" data-mode="fullscreen">
                            <i class="fa-solid fa-expand mr-1.5"></i> Tam Ekran
                        </button>
                        <button type="button" class="segment-btn" data-mode="custom">
                            <i class="fa-solid fa-crop mr-1.5"></i> Kırp
                        </button>
                    </div>
                </div>

                <!-- Dynamic Controls (Cam/Mic Status) -->
                <div class="flex items-center gap-4">
                    <!-- Audio Visualizer (Visible only if Mic is active) -->
                    <div id="audio-preview" class="hidden items-center gap-2 border-r border-white/10 pr-4">
                        <i class="fa-solid fa-microphone-lines text-slate-500 text-xs"></i>
                        <div class="flex items-end gap-0.5 h-6">
                            <div class="audio-meter h-2"></div>
                            <div class="audio-meter h-3"></div>
                            <div class="audio-meter h-5"></div>
                            <div class="audio-meter h-3"></div>
                            <div class="audio-meter h-2"></div>
                        </div>
                    </div>

                    <!-- Camera Position Controls (Visible only if Cam is active) -->
                    <div id="cam-controls" class="hidden items-center gap-3 border-r border-white/10 pr-4">
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] uppercase text-slate-500 font-bold leading-none">Konum</span>
                        </div>
                        <div class="grid grid-cols-2 gap-1 w-8 h-8 bg-slate-800 rounded p-0.5" title="Kamera Konumu">
                            <button class="cam-pos-btn" data-pos="top-left"></button>
                            <button class="cam-pos-btn" data-pos="top-right"></button>
                            <button class="cam-pos-btn" data-pos="bottom-left"></button>
                            <button class="cam-pos-btn active" data-pos="bottom-right"></button> <!-- Default Active -->
                        </div>
                        <button id="cam-shape-btn" class="w-8 h-8 rounded bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center text-xs border border-white/5 transition-colors" title="Şekil Değiştir (Yuvarlak/Kare)">
                            <i class="fa-solid fa-circle"></i>
                        </button>
                    </div>

                    <div class="h-8 w-px bg-white/10 hidden md:block"></div>
                    <button id="start-recording-btn" class="bg-red-600 hover:bg-red-500 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-red-900/20 flex items-center gap-2 transition-all hover:scale-105 active:scale-95">
                        <span class="relative flex h-3 w-3 mr-1">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-white"></span>
                        </span>
                        KAYDI BAŞLAT
                    </button>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="flex-1 relative bg-black/90 overflow-hidden flex items-center justify-center p-8">
                <div id="crop-container" class="relative shadow-2xl ring-1 ring-white/10 rounded-lg overflow-hidden bg-black">
                    <!-- Source Video Preview (Under crop box) -->
                    <video id="crop-source-video" autoplay muted class="block max-w-full max-h-[80vh] opacity-100"></video>
                    
                    <!-- Draggable Crop Box -->
                    <div id="crop-box" class="absolute hidden" style="top: 10%; left: 10%; width: 50%; height: 50%;">
                        <div class="resize-handle handle-nw" data-dir="nw"></div>
                        <div class="resize-handle handle-ne" data-dir="ne"></div>
                        <div class="resize-handle handle-sw" data-dir="sw"></div>
                        <div class="resize-handle handle-se" data-dir="se"></div>
                        
                        <!-- Size Label on Box -->
                        <div class="absolute -top-8 left-0 bg-white text-black text-[10px] font-bold px-2 py-1 rounded shadow-sm opacity-90">
                            Serbest Alan
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 1: Setup Panel -->
        <div id="setup-panel" class="w-full max-w-[480px] glass rounded-3xl p-10 shadow-2xl relative overflow-hidden animate-fade-in">
            <div class="absolute -top-32 -right-32 w-64 h-64 bg-indigo-500/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-32 -left-32 w-64 h-64 bg-rose-500/20 rounded-full blur-[80px]"></div>
            
            <div class="text-center mb-8 relative z-10">
                <h2 class="text-3xl font-bold text-white mb-2 tracking-tight">Yeni Kayıt</h2>
                <p class="text-slate-400 text-sm">Ses ve görüntü kaynaklarınızı seçin.</p>
            </div>

            <div class="space-y-4 relative z-10">
                <!-- Toggle Group -->
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer bg-slate-800/40 hover:bg-slate-800/60 border border-white/5 rounded-2xl p-5 flex flex-col items-center justify-center gap-3 transition-all group">
                        <div class="w-12 h-12 rounded-full bg-slate-700/50 flex items-center justify-center group-hover:bg-indigo-500/20 transition-colors">
                            <i class="fa-solid fa-microphone text-xl text-slate-400 group-hover:text-indigo-400 transition-colors" id="icon-mic"></i>
                        </div>
                        <div class="text-center">
                            <span class="text-sm font-medium text-slate-200 block">Mikrofon</span>
                            <span class="text-[10px] text-slate-500">Sesli Anlatım</span>
                        </div>
                        <input type="checkbox" id="mic-toggle" class="accent-indigo-500 w-5 h-5 mt-1 border-white/10 bg-slate-900/50">
                    </label>

                    <label class="cursor-pointer bg-slate-800/40 hover:bg-slate-800/60 border border-white/5 rounded-2xl p-5 flex flex-col items-center justify-center gap-3 transition-all group">
                        <div class="w-12 h-12 rounded-full bg-slate-700/50 flex items-center justify-center group-hover:bg-rose-500/20 transition-colors">
                            <i class="fa-solid fa-video text-xl text-slate-400 group-hover:text-rose-400 transition-colors" id="icon-cam"></i>
                        </div>
                        <div class="text-center">
                            <span class="text-sm font-medium text-slate-200 block">Webcam</span>
                            <span class="text-[10px] text-slate-500">Görüntülü</span>
                        </div>
                        <input type="checkbox" id="cam-toggle" class="accent-rose-500 w-5 h-5 mt-1 border-white/10 bg-slate-900/50">
                    </label>
                </div>

                <button id="init-btn" class="w-full bg-white text-slate-950 hover:bg-slate-200 font-bold py-4 rounded-xl shadow-xl transform transition-all active:scale-[0.98] mt-4 flex items-center justify-center gap-3 text-base">
                    <span>Ekranı Seç & Başla</span>
                    <i class="fa-solid fa-arrow-right text-slate-400"></i>
                </button>
            </div>
        </div>

        <!-- Recording Status Bar (Floating) -->
        <div id="recording-status" class="hidden absolute top-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md border border-white/10 pr-2 pl-6 py-2 rounded-full flex items-center gap-6 shadow-2xl z-[80]">
            <div class="flex items-center gap-3">
                <div class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </div>
                <span class="font-mono text-xl w-20 tracking-wider font-bold" id="timer">00:00</span>
            </div>
            <div class="h-6 w-px bg-white/10"></div>
            <div class="flex gap-2">
                <button id="pause-btn" class="w-9 h-9 rounded-full bg-white/5 hover:bg-white/10 text-yellow-500 flex items-center justify-center transition-colors border border-white/5" title="Duraklat">
                    <i class="fa-solid fa-pause text-xs"></i>
                </button>
                <button id="stop-btn-top" class="w-9 h-9 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg transition-colors" title="Bitir">
                    <i class="fa-solid fa-stop text-xs"></i>
                </button>
            </div>
        </div>

        <!-- VIEW 2: Result & Download Panel -->
        <div id="result-panel" class="hidden w-full h-full flex flex-col items-center justify-center gap-8 animate-fade-in z-30 p-6 relative">
            
            <!-- Video Preview Container -->
            <div class="w-full max-w-5xl bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative group ring-1 ring-white/5 aspect-video flex items-center justify-center bg-zinc-900">
                <video id="preview-video" class="max-w-full max-h-full" controls></video>
                <div class="absolute top-6 left-6 bg-black/50 px-3 py-1.5 rounded-full text-xs backdrop-blur-md text-white border border-white/10 pointer-events-none font-medium flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div> Önizleme
                </div>
            </div>

            <!-- Download Options -->
            <div class="w-full max-w-5xl glass p-6 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                <div>
                    <h3 class="text-white font-bold text-lg mb-1">Kayıt Başarılı!</h3>
                    <p class="text-slate-400 text-sm">Videonuzu istediğiniz formatta indirebilirsiniz.</p>
                </div>
                
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button id="download-mp4" class="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20">
                        <i class="fa-brands fa-windows text-indigo-200"></i> MP4 İndir
                    </button>
                    <button id="download-webm" class="flex-1 md:flex-none bg-slate-800 hover:bg-slate-700 text-white border border-white/10 px-6 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fa-brands fa-chrome text-slate-400"></i> WebM İndir
                    </button>
                    <div class="w-px h-8 bg-white/10 mx-2 hidden md:block"></div>
                    <button id="new-record-btn" class="bg-transparent hover:bg-white/5 text-slate-400 hover:text-white px-4 py-3 rounded-xl transition-colors" title="Sil ve Yeni Kayıt">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Hidden Video Elements for Composition -->
    <video id="src-video-screen" autoplay muted class="hidden"></video>
    <video id="src-video-cam" autoplay muted class="hidden"></video>
    <canvas id="compositor-canvas" class="hidden"></canvas>

    <script>
        /**
         * RecMaster Modern Logic
         */
        
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlobUrl = null;
        let timerInt;
        let totalSeconds = 0;
        let isPaused = false;
        let isCropMode = false;
        
        // Cam & Audio State
        let camPosition = 'bottom-right'; // top-left, top-right, bottom-left, bottom-right
        let camShape = 'circle'; // circle, square
        let audioContext, analyser, dataArray, animationId;
        
        let cropState = { sx: 0, sy: 0, sw: 0, sh: 0 };
        let streams = { display: null, user: null };

        const els = {
            setupPanel: document.getElementById('setup-panel'),
            resultPanel: document.getElementById('result-panel'),
            recordingStatus: document.getElementById('recording-status'),
            countdownOverlay: document.getElementById('countdown-overlay'),
            countdownText: document.getElementById('countdown-text'),
            cropOverlay: document.getElementById('crop-overlay'),
            cropSourceVideo: document.getElementById('crop-source-video'),
            cropBox: document.getElementById('crop-box'),
            cropSizeInfo: document.getElementById('crop-size-info'),
            cropContainer: document.getElementById('crop-container'),
            
            initBtn: document.getElementById('init-btn'),
            startRecordingBtn: document.getElementById('start-recording-btn'),
            stopBtn: document.getElementById('stop-btn-top'),
            pauseBtn: document.getElementById('pause-btn'),
            timer: document.getElementById('timer'),
            statusBadge: document.getElementById('status-badge'),
            previewVideo: document.getElementById('preview-video'),
            micToggle: document.getElementById('mic-toggle'),
            camToggle: document.getElementById('cam-toggle'),
            iconMic: document.getElementById('icon-mic'),
            iconCam: document.getElementById('icon-cam'),
            
            // New Controls
            audioPreview: document.getElementById('audio-preview'),
            camControls: document.getElementById('cam-controls'),
            audioMeters: document.querySelectorAll('.audio-meter'),
            camPosBtns: document.querySelectorAll('.cam-pos-btn'),
            camShapeBtn: document.getElementById('cam-shape-btn')
        };

        // UI Toggles
        els.micToggle.addEventListener('change', (e) => {
            els.iconMic.className = e.target.checked ? "fa-solid fa-microphone text-xl text-indigo-400 transition-colors" : "fa-solid fa-microphone text-xl text-slate-400 transition-colors";
        });
        els.camToggle.addEventListener('change', (e) => {
            els.iconCam.className = e.target.checked ? "fa-solid fa-video text-xl text-rose-400 transition-colors" : "fa-solid fa-video text-xl text-slate-400 transition-colors";
        });

        // Mode Switching
        document.querySelectorAll('.segment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const mode = btn.dataset.mode;
                isCropMode = (mode === 'custom');
                
                if (isCropMode) {
                    els.cropBox.classList.remove('hidden');
                    updateCropLabels();
                } else {
                    els.cropBox.classList.add('hidden');
                    const vidW = els.cropSourceVideo.videoWidth;
                    const vidH = els.cropSourceVideo.videoHeight;
                    cropState = { sx: 0, sy: 0, sw: vidW, sh: vidH };
                    els.cropSizeInfo.innerText = `${vidW}x${vidH}`;
                }
            });
        });

        // Cam Position Controls
        els.camPosBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.camPosBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                camPosition = btn.dataset.pos;
            });
        });

        // Cam Shape Control
        els.camShapeBtn.addEventListener('click', () => {
            if (camShape === 'circle') {
                camShape = 'square';
                els.camShapeBtn.innerHTML = '<i class="fa-solid fa-square"></i>';
            } else {
                camShape = 'circle';
                els.camShapeBtn.innerHTML = '<i class="fa-solid fa-circle"></i>';
            }
        });

        // --- STEP 1: Init Stream ---
        els.initBtn.onclick = async () => {
            const useMic = els.micToggle.checked;
            const useCam = els.camToggle.checked;

            try {
                streams.display = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { frameRate: 60, width: { ideal: 1920 }, height: { ideal: 1080 } }, 
                    audio: true 
                });

                if (useMic || useCam) {
                    try {
                        streams.user = await navigator.mediaDevices.getUserMedia({ 
                            audio: useMic, 
                            video: useCam ? { width: 320, height: 240 } : false 
                        });
                    } catch (err) { alert("Medya izni alınamadı."); }
                }

                // Show UI elements based on selection
                if (useMic && streams.user && streams.user.getAudioTracks().length > 0) {
                    els.audioPreview.classList.remove('hidden');
                    els.audioPreview.classList.add('flex');
                    initAudioVisualizer(streams.user);
                }
                
                if (useCam && streams.user && streams.user.getVideoTracks().length > 0) {
                    els.camControls.classList.remove('hidden');
                    els.camControls.classList.add('flex');
                }

                els.setupPanel.classList.add('hidden');
                setupCropUI();

            } catch (err) {
                console.warn(err);
                els.setupPanel.classList.remove('hidden');
            }
        };

        // Audio Visualizer Logic
        function initAudioVisualizer(stream) {
            audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 32;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            updateVisualizer();
        }

        function updateVisualizer() {
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            
            // Simple visualizer mapping (5 bars)
            for(let i = 0; i < 5; i++) {
                const val = dataArray[i * 2]; // Skip some bins
                const h = Math.max(4, (val / 255) * 20); // Scale height
                els.audioMeters[i].style.height = `${h}px`;
                
                if (val > 100) els.audioMeters[i].classList.add('active');
                else els.audioMeters[i].classList.remove('active');
            }
            animationId = requestAnimationFrame(updateVisualizer);
        }

        // --- Preview Logic ---
        function setupCropUI() {
            els.cropOverlay.classList.remove('hidden');
            els.cropSourceVideo.srcObject = streams.display;
            
            els.cropSourceVideo.onloadedmetadata = () => {
                const vidW = els.cropSourceVideo.videoWidth;
                const vidH = els.cropSourceVideo.videoHeight;
                const contW = els.cropSourceVideo.offsetWidth;
                const scale = contW / vidW;
                
                const boxW = contW * 0.5;
                const boxH = (vidH * scale) * 0.5;
                
                els.cropBox.style.width = `${boxW}px`;
                els.cropBox.style.height = `${boxH}px`;
                els.cropBox.style.left = `${(contW - boxW)/2}px`;
                els.cropBox.style.top = `${((vidH * scale) - boxH)/2}px`;
                
                cropState = { sx: 0, sy: 0, sw: vidW, sh: vidH };
                els.cropSizeInfo.innerText = `${vidW}x${vidH}`;
            };
        }

        // Draggable Logic
        let isDraggingBox = false;
        let isResizing = false;
        let resizeDir = '';
        let startX, startY, startLeft, startTop, startW, startH;

        els.cropContainer.addEventListener('mousedown', (e) => {
            if(!isCropMode) return;
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                resizeDir = e.target.dataset.dir;
                startX = e.clientX; startY = e.clientY;
                startW = els.cropBox.offsetWidth; startH = els.cropBox.offsetHeight;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            } else if (e.target.id === 'crop-box' || els.cropBox.contains(e.target)) {
                if(mediaRecorder && mediaRecorder.state === 'recording') return;
                isDraggingBox = true;
                startX = e.clientX; startY = e.clientY;
                startLeft = els.cropBox.offsetLeft; startTop = els.cropBox.offsetTop;
                e.preventDefault();
            }
        });

        window.addEventListener('mousemove', (e) => {
            if(!isCropMode) return;
            const containerRect = els.cropContainer.getBoundingClientRect();
            
            if (isDraggingBox) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                let newLeft = Math.max(0, Math.min(startLeft + dx, containerRect.width - els.cropBox.offsetWidth));
                let newTop = Math.max(0, Math.min(startTop + dy, containerRect.height - els.cropBox.offsetHeight));
                
                els.cropBox.style.left = `${newLeft}px`;
                els.cropBox.style.top = `${newTop}px`;
                updateCropLabels();
            } else if (isResizing) {
                let dx = e.clientX - startX;
                let dy = e.clientY - startY;
                if (resizeDir.includes('e')) els.cropBox.style.width = `${startW + dx}px`;
                if (resizeDir.includes('s')) els.cropBox.style.height = `${startH + dy}px`;
                updateCropLabels();
            }
        });

        window.addEventListener('mouseup', () => { isDraggingBox = false; isResizing = false; });

        function updateCropLabels() {
            const vidW = els.cropSourceVideo.videoWidth;
            const containerW = els.cropSourceVideo.offsetWidth;
            const scale = vidW / containerW;

            cropState.sx = els.cropBox.offsetLeft * scale;
            cropState.sy = els.cropBox.offsetTop * scale;
            cropState.sw = els.cropBox.offsetWidth * scale;
            cropState.sh = els.cropBox.offsetHeight * scale;
            els.cropSizeInfo.innerText = `${Math.round(cropState.sw)}x${Math.round(cropState.sh)}`;
        }

        // --- STEP 2: Start Recording ---
        els.startRecordingBtn.onclick = () => {
            els.countdownOverlay.classList.remove('hidden');
            let count = 3;
            els.countdownText.innerText = count;
            const cInt = setInterval(() => {
                count--;
                if(count > 0) els.countdownText.innerText = count;
                else {
                    clearInterval(cInt);
                    els.countdownOverlay.classList.add('hidden');
                    beginRecording();
                }
            }, 1000);
        };

        async function beginRecording() {
            els.statusBadge.innerText = "KAYITTA";
            els.statusBadge.className = "text-[10px] uppercase tracking-wider px-2 py-1 rounded border border-red-500 text-red-400 font-bold animate-pulse bg-red-900/20";
            els.recordingStatus.classList.remove('hidden');
            
            // Visual Guide Mode
            if (isCropMode) {
                els.cropBox.classList.add('recording-mode');
                document.querySelectorAll('.resize-handle').forEach(h => h.classList.add('hidden'));
            } else {
                els.cropBox.classList.add('hidden');
            }

            const canvas = document.getElementById('compositor-canvas');
            const ctx = canvas.getContext('2d');
            const vScreen = document.getElementById('src-video-screen');
            const vCam = document.getElementById('src-video-cam');

            vScreen.srcObject = streams.display;
            await vScreen.play();

            canvas.width = cropState.sw;
            canvas.height = cropState.sh;

            // Audio Mixing
            const dest = audioContext ? audioContext.createMediaStreamDestination() : new AudioContext().createMediaStreamDestination();
            const ac = audioContext || new AudioContext(); // Reuse or new
            
            if(streams.display.getAudioTracks().length) ac.createMediaStreamSource(streams.display).connect(dest);
            
            if(streams.user && streams.user.getAudioTracks().length) {
                const ms = ac.createMediaStreamSource(streams.user);
                ms.connect(ac.createGain()).connect(dest);
            }

            const useCam = els.camToggle.checked;
            if (useCam && streams.user) {
                vCam.srcObject = streams.user;
                await vCam.play();
            }

            let isDrawing = true;
            function draw() {
                if(!isDrawing) return;
                
                // Draw Crop Area
                ctx.drawImage(vScreen, 
                    cropState.sx, cropState.sy, cropState.sw, cropState.sh, 
                    0, 0, canvas.width, canvas.height
                );

                if (useCam && streams.user) {
                    const size = Math.min(canvas.width, canvas.height) * 0.25; 
                    const m = 30;
                    let x, y;

                    // Calculate Cam Position
                    if (camPosition === 'top-left') { x = m; y = m; }
                    else if (camPosition === 'top-right') { x = canvas.width - size - m; y = m; }
                    else if (camPosition === 'bottom-left') { x = m; y = canvas.height - size - m; }
                    else { x = canvas.width - size - m; y = canvas.height - size - m; } // bottom-right

                    ctx.save();
                    ctx.beginPath();
                    
                    if (camShape === 'circle') {
                        ctx.arc(x+size/2, y+size/2, size/2, 0, Math.PI*2);
                    } else {
                        // Round rect for square shape
                        ctx.roundRect(x, y, size, size, 20); 
                    }
                    
                    ctx.clip();
                    ctx.drawImage(vCam, x, y, size, size);
                    ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();
                    ctx.restore();
                }
                requestAnimationFrame(draw);
            }
            draw();

            const finalStream = canvas.captureStream(60);
            if(dest.stream.getAudioTracks().length) finalStream.addTrack(dest.stream.getAudioTracks()[0]);

            let mime = 'video/mp4';
            if(!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm;codecs=vp9';

            mediaRecorder = new MediaRecorder(finalStream, { mimeType: mime });
            recordedChunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                isDrawing = false;
                if (audioContext) audioContext.close();
                if (animationId) cancelAnimationFrame(animationId);
                
                streams.display.getTracks().forEach(t=>t.stop());
                if(streams.user) streams.user.getTracks().forEach(t=>t.stop());
                finalize();
            };
            
            streams.display.getVideoTracks()[0].onended = () => mediaRecorder.stop();
            mediaRecorder.start();
            
            totalSeconds = 0;
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                if(!isPaused) {
                    totalSeconds++;
                    const m = Math.floor(totalSeconds/60).toString().padStart(2,'0');
                    const s = (totalSeconds%60).toString().padStart(2,'0');
                    els.timer.innerText = `${m}:${s}`;
                }
            }, 1000);
        }

        els.stopBtn.onclick = () => mediaRecorder.stop();
        els.pauseBtn.onclick = () => {
            if(mediaRecorder.state === "recording") {
                mediaRecorder.pause(); isPaused = true;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
                els.pauseBtn.classList.add('text-green-500');
            } else {
                mediaRecorder.resume(); isPaused = false;
                els.pauseBtn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                els.pauseBtn.classList.remove('text-green-500');
            }
        };

        function finalize() {
            clearInterval(timerInt);
            els.recordingStatus.classList.add('hidden');
            els.cropOverlay.classList.add('hidden');
            els.resultPanel.classList.remove('hidden');
            els.statusBadge.innerText = "TAMAMLANDI";
            
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            recordedBlobUrl = URL.createObjectURL(blob);
            els.previewVideo.src = recordedBlobUrl;
        }

        function downloadVideo(ext) {
            if(!recordedBlobUrl) return;
            const a = document.createElement('a');
            a.href = recordedBlobUrl;
            a.download = `RecMaster_${Date.now()}.${ext}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        
        document.getElementById('download-mp4').onclick = () => downloadVideo('mp4');
        document.getElementById('download-webm').onclick = () => downloadVideo('webm');
        document.getElementById('new-record-btn').onclick = () => location.reload();

    </script>
</body>
</html>
